<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Universal File Viewer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&family=Syne:wght@400;600;800&display=swap');
:root{--bg:#0a0a0f;--surface:#111118;--surface2:#16161f;--border:#2a2a3a;--accent:#6ee7f7;--accent2:#b47aff;--text:#e8e8f0;--muted:#6b6b80;--success:#4ade80;--warning:#fbbf24;--error:#f87171;--hh:56px;--bh:44px;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;display:flex;flex-direction:column;height:100dvh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 40% at 20% 20%,rgba(110,231,247,.04) 0%,transparent 60%),radial-gradient(ellipse 50% 50% at 80% 80%,rgba(180,122,255,.04) 0%,transparent 60%);pointer-events:none;z-index:0;}

/* HEADER */
header{flex-shrink:0;background:rgba(10,10,15,.98);border-bottom:1px solid var(--border);position:relative;z-index:100;}
.hrow{height:var(--hh);display:flex;align-items:center;gap:8px;padding:0 14px;}
.logo{font-size:17px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;flex-shrink:0;}
.hsp{flex:1;}
.hbtn{background:none;border:1px solid var(--border);color:var(--muted);width:38px;height:38px;border-radius:8px;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;position:relative;}
.hbtn:active,.hbtn.active{border-color:var(--accent);color:var(--accent);}
.hbtn .badge{position:absolute;top:-4px;right:-4px;background:var(--accent);color:#000;font-size:9px;font-weight:700;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;}

/* SEARCH BAR */
.search-bar{overflow:hidden;max-height:0;transition:max-height .25s ease,padding .25s ease;padding:0 14px;}
.search-bar.open{max-height:60px;padding:10px 14px;border-top:1px solid var(--border);}
.siw{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0 12px;gap:8px;}
.siw:focus-within{border-color:var(--accent);}
.siw .si{color:var(--muted);font-size:14px;flex-shrink:0;}
.sbox{background:none;border:none;color:var(--text);padding:10px 0;font-family:'JetBrains Mono',monospace;font-size:13px;outline:none;flex:1;width:100%;}
.sclear{background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;padding:4px;flex-shrink:0;display:none;}
.sclear.vis{display:block;}

/* CAT STRIP */
.cat-strip{display:flex;gap:6px;overflow-x:auto;padding:8px 14px;border-top:1px solid var(--border);-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.cat-strip::-webkit-scrollbar{display:none;}
.cat-chip{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);font-size:12px;white-space:nowrap;cursor:pointer;flex-shrink:0;transition:all .15s;min-height:34px;color:var(--muted);}
.cat-chip:active,.cat-chip.active{background:rgba(110,231,247,.1);border-color:var(--accent);color:var(--accent);}

/* APP BODY */
.app-body{flex:1;display:flex;overflow:hidden;position:relative;z-index:1;}

/* SIDEBAR desktop */
.sidebar{width:230px;flex-shrink:0;border-right:1px solid var(--border);overflow-y:auto;background:var(--surface);display:flex;flex-direction:column;z-index:50;}
@media(max-width:640px){.sidebar{display:none;}}
.sidebar-cats{flex:1;overflow-y:auto;padding-bottom:12px;}
.sl{font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);padding:10px 16px 4px;text-transform:uppercase;}
.si-item{display:flex;align-items:center;gap:10px;padding:11px 16px;cursor:pointer;font-size:13px;border-left:2px solid transparent;transition:all .15s;min-height:44px;}
.si-item:active,.si-item:hover{background:rgba(255,255,255,.04);}
.si-item.active{background:rgba(110,231,247,.06);border-left-color:var(--accent);color:var(--accent);}
.si-item .ico{font-size:17px;width:22px;text-align:center;flex-shrink:0;}
.si-item .cnt{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);background:var(--surface2);padding:2px 6px;border-radius:10px;flex-shrink:0;}

/* CONTENT */
.content{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

/* DROP ZONE */
.drop-zone{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:24px 20px;overflow-y:auto;}
.drop-zone.drag-over{background:rgba(110,231,247,.03);}
.drop-ring{width:100px;height:100px;border-radius:50%;border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:38px;animation:pulse 3s ease-in-out infinite;flex-shrink:0;}
@keyframes pulse{0%,100%{border-color:var(--border);}50%{border-color:rgba(110,231,247,.4);box-shadow:0 0 24px rgba(110,231,247,.08);}}
.drag-over .drop-ring{border-color:var(--accent);animation:none;}
.drop-text{font-size:16px;font-weight:600;text-align:center;}
.drop-sub{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;text-align:center;line-height:1.8;}
.browse-btn{background:linear-gradient(135deg,rgba(110,231,247,.15),rgba(180,122,255,.15));border:1px solid rgba(110,231,247,.3);color:var(--accent);padding:13px 32px;border-radius:8px;font-family:'Syne',sans-serif;font-size:14px;font-weight:600;cursor:pointer;min-height:48px;}
.browse-btn:active{transform:scale(.97);}
.type-pills{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:380px;}
.tpill{font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 9px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);}
#fi{display:none;}

/* VIEWER */
.vwrap{display:none;flex:1;flex-direction:column;overflow:hidden;}
.vwrap.active{display:flex;}
.vtbar{display:flex;align-items:center;gap:7px;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;min-height:50px;overflow:hidden;}
.vbadge{font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 8px;border-radius:4px;font-weight:600;flex-shrink:0;border:1px solid var(--border);background:var(--surface2);max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.vname{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0;}
.tbtn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 11px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:11px;cursor:pointer;flex-shrink:0;min-height:34px;white-space:nowrap;}
.tbtn:active{border-color:var(--accent);color:var(--accent);}
.cbtn{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.cbtn:active{color:var(--error);}
.vbody{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;}

/* STATUS BAR */
.sbar{height:var(--bh);display:flex;align-items:center;gap:10px;padding:0 14px;border-top:1px solid var(--border);background:var(--surface);font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);flex-shrink:0;overflow:hidden;position:relative;z-index:10;}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--success);flex-shrink:0;}
#sfile{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* THEME */
body.light{--bg:#f4f4f8;--surface:#ffffff;--surface2:#f0f0f5;--border:#dddde8;--text:#1a1a2e;--muted:#8888a0;--success:#16a34a;--warning:#d97706;--error:#dc2626;}
body.light .logo{background:linear-gradient(135deg,#0891b2,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}

/* PANELS (recent, tools) */
.panel{position:fixed;inset:0;z-index:200;display:none;}
.panel.open{display:flex;}
.panel-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);}
.panel-sheet{position:absolute;bottom:0;left:0;right:0;background:var(--surface);border-radius:16px 16px 0 0;border-top:1px solid var(--border);max-height:80vh;display:flex;flex-direction:column;animation:slideup .25s ease;}
@keyframes slideup{from{transform:translateY(100%);}to{transform:translateY(0);}}
.panel-header{display:flex;align-items:center;padding:16px 16px 12px;border-bottom:1px solid var(--border);flex-shrink:0;}
.panel-title{font-size:15px;font-weight:700;flex:1;}
.panel-close{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:4px;}
.panel-body{overflow-y:auto;flex:1;padding:16px;}

/* RECENT FILES */
.recent-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;cursor:pointer;transition:background .15s;border:1px solid transparent;}
.recent-item:active{background:var(--surface2);}
.ri-icon{font-size:28px;flex-shrink:0;}
.ri-info{flex:1;min-width:0;}
.ri-name{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ri-meta{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px;}
.ri-del{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:6px;flex-shrink:0;}

/* TOOLS PANEL */
.tools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;}
.tool-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:all .15s;text-align:center;}
.tool-card:active{border-color:var(--accent);}
.tool-icon{font-size:28px;margin-bottom:8px;}
.tool-name{font-size:12px;font-weight:600;margin-bottom:3px;}
.tool-desc{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;}

/* CONVERTER */
.conv-wrap{padding:16px;display:flex;flex-direction:column;gap:14px;max-width:700px;margin:0 auto;width:100%;}
.conv-section{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.conv-head{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700;font-size:13px;display:flex;align-items:center;gap:8px;}
.conv-body{padding:14px;}
.conv-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
.conv-label{font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace;width:80px;flex-shrink:0;}
.conv-select{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;flex:1;min-width:100px;}
.conv-select:focus{border-color:var(--accent);}
.conv-btn{background:linear-gradient(135deg,rgba(110,231,247,.15),rgba(180,122,255,.15));border:1px solid rgba(110,231,247,.3);color:var(--accent);padding:10px 20px;border-radius:7px;font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;min-height:40px;}
.conv-btn:active{transform:scale(.97);}
.conv-textarea{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;width:100%;resize:vertical;min-height:100px;}
.conv-textarea:focus{border-color:var(--accent);}
.conv-output{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px 12px;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;min-height:60px;color:var(--text);max-height:300px;overflow:auto;}
.conv-tabs{display:flex;border-bottom:1px solid var(--border);}
.conv-tab{padding:10px 16px;font-size:12px;font-family:'JetBrains Mono',monospace;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;flex-shrink:0;}
.conv-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.conv-canvas-wrap{display:flex;justify-content:center;padding:16px;}
#qr-canvas{background:#fff;border-radius:8px;}

/* DIFF VIEWER */
.diff-drop-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.diff-drop{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;transition:border-color .15s;}
.diff-drop.loaded{border-color:var(--success);color:var(--success);}
.diff-drop:active{border-color:var(--accent);}
.diff-output{display:grid;grid-template-columns:1fr 1fr;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;font-family:'JetBrains Mono',monospace;font-size:11px;}
@media(max-width:500px){.diff-output,.diff-drop-row{grid-template-columns:1fr;}}
.diff-col{overflow:auto;max-height:400px;}
.diff-col-head{padding:8px 12px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:10px;font-weight:600;color:var(--muted);position:sticky;top:0;z-index:2;}
.diff-line{padding:2px 10px;line-height:1.7;white-space:pre;display:block;}
.diff-add{background:rgba(74,222,128,.1);color:#4ade80;}
.diff-del{background:rgba(248,113,113,.1);color:#f87171;}
.diff-eq{color:var(--muted);}

/* IMAGE EDITOR */
.img-editor{display:flex;flex-direction:column;height:100%;}
.img-toolbar{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--surface);flex-wrap:wrap;flex-shrink:0;}
.img-canvas-wrap{flex:1;overflow:auto;display:flex;align-items:center;justify-content:center;background:repeating-conic-gradient(rgba(255,255,255,.03) 0% 25%,transparent 0% 50%) 0 0/16px 16px;padding:12px;}
#img-canvas{max-width:100%;height:auto;}
.img-slider{display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);}
.img-slider input[type=range]{accent-color:var(--accent);width:80px;}

/* ZIP BROWSER */
.zip-list{font-family:'JetBrains Mono',monospace;font-size:12px;}
.zip-folder{color:var(--warning);cursor:pointer;padding:6px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(255,255,255,.03);}
.zip-folder:active{background:var(--surface2);}
.zip-file{color:var(--text);padding:6px 12px 6px 32px;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(255,255,255,.03);cursor:pointer;}
.zip-file:active{background:var(--surface2);}
.zip-size{margin-left:auto;color:var(--muted);font-size:10px;flex-shrink:0;}
.zip-extract-btn{background:var(--surface2);border:1px solid var(--border);color:var(--accent);padding:4px 10px;border-radius:4px;font-size:10px;cursor:pointer;flex-shrink:0;}

/* EXIF */
.exif-wrap{padding:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;}
.exif-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;}
.exif-label{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.exif-val{font-size:13px;font-weight:600;color:var(--text);word-break:break-all;}

/* WAVEFORM */
.waveform-wrap{display:flex;flex-direction:column;height:100%;}
.waveform-canvas-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:16px;}
#wave-canvas{width:100%;max-height:200px;border-radius:8px;}
.waveform-player{padding:12px 16px;border-top:1px solid var(--border);background:var(--surface);}

/* COLOR PALETTE */
.palette-wrap{padding:16px;}
.palette-img{max-width:100%;max-height:200px;border-radius:8px;margin-bottom:16px;display:block;margin-left:auto;margin-right:auto;}
.palette-colors{display:flex;flex-wrap:wrap;gap:10px;}
.pal-swatch{width:60px;text-align:center;cursor:pointer;}
.pal-color{width:60px;height:60px;border-radius:8px;margin-bottom:4px;border:1px solid rgba(255,255,255,.1);}
.pal-hex{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);}

/* HASH CHECKER */
.hash-wrap{padding:16px;display:flex;flex-direction:column;gap:12px;}
.hash-row{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;}
.hash-label{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:8px;}
.hash-val{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);word-break:break-all;cursor:pointer;}
.hash-copy{background:none;border:1px solid var(--border);color:var(--muted);padding:3px 8px;border-radius:4px;font-size:10px;cursor:pointer;flex-shrink:0;margin-left:auto;}
.hash-input{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;width:100%;margin-top:8px;}
.hash-input:focus{border-color:var(--accent);}
.hash-match{padding:6px 10px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:11px;margin-top:6px;display:none;}
.hash-match.ok{background:rgba(74,222,128,.1);color:var(--success);display:block;}
.hash-match.fail{background:rgba(248,113,113,.1);color:var(--error);display:block;}

/* BIN MAGIC */
.magic-wrap{padding:16px;display:flex;flex-direction:column;gap:12px;}
.magic-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;align-items:center;gap:14px;}
.magic-icon{font-size:36px;flex-shrink:0;}
.magic-detected{font-size:15px;font-weight:700;margin-bottom:4px;}
.magic-sig{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);}
.magic-confidence{font-size:11px;padding:3px 8px;border-radius:10px;background:rgba(74,222,128,.1);color:var(--success);margin-top:4px;display:inline-block;}

/* SVG EDITOR */
.svg-editor{display:grid;grid-template-columns:1fr 1fr;height:100%;gap:0;}
@media(max-width:500px){.svg-editor{grid-template-columns:1fr;grid-template-rows:1fr 1fr;}}
.svg-code{border-right:1px solid var(--border);}
.svg-code textarea{width:100%;height:100%;background:var(--bg);border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:14px;outline:none;resize:none;line-height:1.7;}
.svg-preview{display:flex;align-items:center;justify-content:center;background:repeating-conic-gradient(rgba(255,255,255,.03) 0% 25%,transparent 0% 50%) 0 0/16px 16px;padding:16px;}
.svg-preview svg,.svg-preview img{max-width:100%;max-height:100%;}

/* VIEWERS (shared) */
.image-viewer{display:flex;align-items:center;justify-content:center;min-height:100%;padding:14px;background:repeating-conic-gradient(rgba(255,255,255,.03) 0% 25%,transparent 0% 50%) 0 0/16px 16px;}
.image-viewer img{max-width:100%;height:auto;border-radius:4px;box-shadow:0 8px 40px rgba(0,0,0,.5);}
.video-viewer{display:flex;align-items:center;justify-content:center;min-height:100%;padding:10px;background:#000;}
.video-viewer video{max-width:100%;height:auto;border-radius:4px;}
.audio-viewer{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;gap:20px;padding:28px 20px;}
.audio-icon{font-size:64px;animation:flt 3s ease-in-out infinite;}
@keyframes flt{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.audio-viewer audio{width:100%;max-width:380px;}
.pdf-viewer{width:100%;height:100%;border:none;display:block;}
.table-viewer{height:100%;overflow:auto;}
.data-table{border-collapse:collapse;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:nowrap;}
.data-table th{background:var(--surface2);padding:9px 13px;border:1px solid var(--border);text-align:left;font-weight:600;color:var(--accent);position:sticky;top:0;z-index:2;}
.data-table td{padding:7px 13px;border:1px solid var(--border);}
.data-table tr:hover td{background:rgba(255,255,255,.02);}
.json-viewer{padding:14px;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;}
.jk{color:var(--accent)}.js{color:#86efac}.jn{color:#f9a8d4}.jb{color:#c084fc}.jnull{color:var(--muted)}
.hex-viewer{padding:14px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.9;}
.hex-row{display:flex;gap:10px;}
.hxa{color:var(--muted);width:60px;flex-shrink:0;}
.hxb{color:var(--accent);flex:1;}
.hxc{color:#86efac;display:none;}
@media(min-width:480px){.hxc{display:block;}}
.md-viewer{max-width:700px;margin:0 auto;padding:20px 16px;font-size:14px;line-height:1.8;}
.md-viewer h1{font-size:22px;font-weight:800;margin-bottom:14px;color:var(--accent);}
.md-viewer h2{font-size:18px;font-weight:700;margin:22px 0 10px;border-bottom:1px solid var(--border);padding-bottom:6px;}
.md-viewer h3{font-size:15px;font-weight:700;margin:16px 0 8px;color:var(--accent2);}
.md-viewer p{margin-bottom:12px;color:#c4c4d4;}
.md-viewer code{font-family:'JetBrains Mono',monospace;background:var(--surface2);padding:2px 5px;border-radius:3px;font-size:11px;color:var(--accent);}
.md-viewer pre{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:12px;margin:12px 0;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:11px;}
.md-viewer ul,.md-viewer ol{padding-left:18px;margin-bottom:12px;color:#c4c4d4;}
.md-viewer blockquote{border-left:3px solid var(--accent2);padding-left:12px;margin:12px 0;color:var(--muted);font-style:italic;}
.md-viewer a{color:var(--accent);}
.md-viewer img{max-width:100%;border-radius:6px;}
.md-viewer hr{border:none;border-top:1px solid var(--border);margin:18px 0;}
.md-viewer strong{color:var(--text);font-weight:700;}
.code-viewer{margin:0;padding:10px 0;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;color:var(--text);white-space:pre;tab-size:2;}
.code-line{display:flex;}
.ln{color:var(--muted);width:36px;flex-shrink:0;user-select:none;text-align:right;padding-right:12px;font-size:10px;}
.lc{flex:1;padding-right:12px;}
.kw{color:#c084fc}.str{color:#86efac}.num{color:#f9a8d4}.cmt{color:#4b5563;font-style:italic}.tag{color:#f87171}.attr{color:var(--warning)}.val2{color:#86efac}.prop{color:var(--accent2)}
.font-viewer{padding:16px;display:flex;flex-direction:column;gap:16px;}
[contenteditable][placeholder]:empty:before{content:attr(placeholder);color:var(--muted);pointer-events:none;}
.font-preview{border:1px solid var(--border);border-radius:8px;padding:14px;background:var(--surface);}
.fps{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--muted);margin-bottom:8px;}
.ext-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:5px;padding:12px;}
.ext-chip{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:6px 4px;font-family:'JetBrains Mono',monospace;font-size:10px;text-align:center;color:var(--muted);}
.ext-chip:active{border-color:var(--accent);color:var(--accent);}
.map-viewer{width:100%;height:100%;position:relative;}
.map-viewer #lmap{width:100%;height:100%;}
.map-stats{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(10,10,15,.9);border:1px solid var(--border);border-radius:8px;padding:7px 14px;z-index:1000;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text);display:flex;gap:14px;pointer-events:none;}
.msv{color:var(--accent);font-weight:600;}
.model-viewer{width:100%;height:100%;position:relative;background:#0d0d14;}
.model-viewer canvas{width:100%!important;height:100%!important;display:block;}
.mctrl{position:absolute;top:10px;right:10px;z-index:10;display:flex;flex-direction:column;gap:5px;}
.mbtn{background:rgba(10,10,15,.85);border:1px solid var(--border);color:var(--text);width:34px;height:34px;border-radius:6px;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.mbtn:active{border-color:var(--accent);color:var(--accent);}
.mhint{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(10,10,15,.7);border:1px solid var(--border);border-radius:6px;padding:5px 12px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);pointer-events:none;white-space:nowrap;}
.xlsx-viewer{height:100%;display:flex;flex-direction:column;}
.sheet-tabs{display:flex;overflow-x:auto;flex-shrink:0;border-bottom:1px solid var(--border);background:var(--surface);scrollbar-width:none;}
.sheet-tabs::-webkit-scrollbar{display:none;}
.stab{padding:9px 15px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;min-height:36px;flex-shrink:0;}
.stab.active{color:var(--accent);border-bottom-color:var(--accent);}
.sheet-content{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;}
.docx-viewer{max-width:720px;margin:0 auto;padding:28px 16px;font-size:14px;line-height:1.8;color:#d4d4e4;}
.docx-viewer h1,.docx-viewer h2,.docx-viewer h3{color:var(--text);margin:18px 0 8px;font-weight:700;}
.docx-viewer h1{font-size:22px;color:var(--accent);}
.docx-viewer h2{font-size:18px;}
.docx-viewer h3{font-size:15px;color:var(--accent2);}
.docx-viewer p{margin-bottom:10px;}
.docx-viewer table{border-collapse:collapse;width:100%;margin:14px 0;}
.docx-viewer td,.docx-viewer th{border:1px solid var(--border);padding:7px 11px;}
.docx-viewer th{background:var(--surface2);color:var(--accent);}
.midi-viewer{padding:16px;display:flex;flex-direction:column;gap:14px;}
.midi-header{display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.piano-roll{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.piano-roll canvas{display:block;}
.midi-info{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);}
.midi-info span{color:var(--text);margin-left:5px;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

/* VIDEO THUMBNAIL STRIP */
.video-wrap{display:flex;flex-direction:column;height:100%;}
.video-main{flex:1;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.video-main video{max-width:100%;max-height:100%;}
.thumb-strip{display:flex;gap:4px;overflow-x:auto;padding:8px;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;scrollbar-width:none;}
.thumb-strip::-webkit-scrollbar{display:none;}
.thumb{width:80px;height:45px;object-fit:cover;border-radius:4px;cursor:pointer;opacity:.6;flex-shrink:0;border:1px solid transparent;transition:all .15s;}
.thumb.active,.thumb:active{opacity:1;border-color:var(--accent);}

/* ICO VIEWER */
.ico-viewer{padding:16px;display:flex;flex-direction:column;gap:14px;}
.ico-sizes{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;}
.ico-size-wrap{text-align:center;}
.ico-label{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-top:4px;}
canvas.ico-canvas{border:1px solid var(--border);border-radius:4px;background:repeating-conic-gradient(rgba(255,255,255,.05) 0% 25%,transparent 0% 50%) 0 0/8px 8px;}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="logo">‚¨° FILE VIEWER</div>
    <div class="hsp"></div>
    <button class="hbtn" id="btn-recent" onclick="openPanel('recent')" title="Recent files">üïê</button>
    <button class="hbtn" id="btn-tools" onclick="openPanel('tools')" title="Tools & Converter">üîß</button>
    <button class="hbtn" id="btn-theme" onclick="toggleTheme()" title="Toggle theme">üåô</button>
    <button class="hbtn" id="btn-search" onclick="toggleSearch()" title="Search">üîç</button>
  </div>
  <div class="search-bar" id="search-bar">
    <div class="siw">
      <span class="si">üîç</span>
      <input class="sbox" id="sbox" placeholder="Search extensions‚Ä¶ e.g. gpx, glb, xlsx" autocomplete="off" spellcheck="false">
      <button class="sclear" id="sclear" onclick="clearSearch()">‚úï</button>
    </div>
  </div>
  <div class="cat-strip" id="cat-strip"></div>
</header>

<!-- Recent panel -->
<div class="panel" id="panel-recent">
  <div class="panel-overlay" onclick="closePanel('recent')"></div>
  <div class="panel-sheet">
    <div class="panel-header">
      <div class="panel-title">üïê Recent Files</div>
      <button class="panel-close" onclick="closePanel('recent')">‚úï</button>
    </div>
    <div class="panel-body" id="recent-list"></div>
  </div>
</div>

<!-- Tools panel -->
<div class="panel" id="panel-tools">
  <div class="panel-overlay" onclick="closePanel('tools')"></div>
  <div class="panel-sheet">
    <div class="panel-header">
      <div class="panel-title">üîß Tools</div>
      <button class="panel-close" onclick="closePanel('tools')">‚úï</button>
    </div>
    <div class="panel-body">
      <div class="tools-grid">
        <div class="tool-card" onclick="openTool('converter')"><div class="tool-icon">üîÑ</div><div class="tool-name">Converter</div><div class="tool-desc">30+ conversions</div></div>
        <div class="tool-card" onclick="openTool('diff')"><div class="tool-icon">‚ö°</div><div class="tool-name">Diff Viewer</div><div class="tool-desc">Compare 2 files</div></div>
        <div class="tool-card" onclick="openTool('hash')"><div class="tool-icon">üîí</div><div class="tool-name">Hash Checker</div><div class="tool-desc">MD5 SHA1 SHA256</div></div>
        <div class="tool-card" onclick="openTool('qr')"><div class="tool-icon">üì±</div><div class="tool-name">QR Code</div><div class="tool-desc">Encode any text</div></div>
        <div class="tool-card" onclick="openTool('text')"><div class="tool-icon">üìù</div><div class="tool-name">Text Tools</div><div class="tool-desc">Sort dedupe count</div></div>
        <div class="tool-card" onclick="openTool('img-edit')"><div class="tool-icon">üé®</div><div class="tool-name">Image Editor</div><div class="tool-desc">Filters resize crop</div></div>
      </div>
    </div>
  </div>
</div>

<div class="app-body">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-cats" id="sidebar-cats"></div>
  </div>
  <div class="content">
    <div class="drop-zone" id="dz">
      <div class="drop-ring">üìÇ</div>
      <div class="drop-text">Tap to open any file</div>
      <div class="drop-sub">Images ¬∑ Video ¬∑ Audio ¬∑ Code ¬∑ PDF ¬∑ CSV<br>JSON ¬∑ DOCX ¬∑ XLSX ¬∑ GLB ¬∑ GPX ¬∑ ZIP ¬∑ MIDI<br>Fonts ¬∑ Archives ¬∑ Binary ¬∑ 500+ formats</div>
      <button class="browse-btn" onclick="document.getElementById('fi').click()">Browse Files</button>
      <div class="type-pills">
        <span class="tpill">üñº Images</span><span class="tpill">üé¨ Video</span><span class="tpill">üéµ Audio</span>
        <span class="tpill">üìÑ PDF</span><span class="tpill">üíª Code</span><span class="tpill">üìä CSV/XLSX</span>
        <span class="tpill">üó∫ GPX/KML</span><span class="tpill">üé≤ GLB/STL</span><span class="tpill">üì¶ ZIP</span>
        <span class="tpill">üî§ Fonts</span><span class="tpill">üéπ MIDI</span><span class="tpill">üîê Certs</span>
      </div>
      <input type="file" id="fi" accept="*/*">
    </div>
    <div class="vwrap" id="vwrap">
      <div class="vtbar">
        <div class="vbadge" id="vbadge">TXT</div>
        <div class="vname" id="vname">filename</div>
        <button class="tbtn" id="tbtn-copy" onclick="copyContent()">Copy</button>
        <button class="tbtn" id="tbtn-share" onclick="shareFile()" style="display:none">Share</button>
        <button class="tbtn" id="tbtn-dl">‚Üì</button>
        <button class="tbtn" id="tbtn-full" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
        <button class="cbtn" onclick="closeViewer()">‚úï</button>
      </div>
      <div class="vbody" id="vbody"></div>
    </div>
  </div>
</div>

<div class="sbar">
  <div class="sdot"></div>
  <div id="sfile">No file loaded</div>
  <div id="senc" style="flex-shrink:0;margin-left:auto"></div>
  <div id="slines" style="flex-shrink:0;margin-left:8px"></div>
</div>

<script>
// ‚îÄ‚îÄ EXTENSION DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EXTS={
  "Web":{icon:"üåê",exts:["html","htm","xhtml","css","scss","sass","less","styl","js","jsx","mjs","ts","tsx","vue","svelte","astro","php","erb","pug","liquid","twig","hbs","ejs","wasm","graphql","gql","webmanifest"]},
  "Backend":{icon:"‚öôÔ∏è",exts:["py","pyw","rb","go","rs","java","kt","swift","c","cpp","h","cs","fs","scala","groovy","dart","r","lua","ex","exs","erl","hs","ml","nim","cr","jl","zig","d","f90","cob","lisp","clj","elm","asm"]},
  "Config":{icon:"üîß",exts:["json","json5","jsonc","jsonl","yaml","yml","toml","ini","cfg","conf","env","properties","plist","xml","dtd","xsd","xsl","reg","editorconfig","eslintrc","prettierrc","gitignore","gitconfig","dockerfile","makefile","cmake","bazel"]},
  "Shell":{icon:"üíª",exts:["sh","bash","zsh","fish","ksh","bat","cmd","ps1","psm1","vbs","ahk","nsi","iss"]},
  "Data":{icon:"üóÑÔ∏è",exts:["sql","sqlite","db","csv","tsv","psv","xls","xlsx","ods","parquet","avro","hdf5","mat","geojson","shp","gpx","kml","npy","npz","pkl","msgpack","bson","proto"]},
  "Documents":{icon:"üìÑ",exts:["txt","log","md","mdx","rst","adoc","org","tex","rtf","doc","docx","odt","pages","pdf","epub","mobi","fb2","djvu","wpd"]},
  "Raster Images":{icon:"üñºÔ∏è",exts:["jpg","jpeg","png","gif","bmp","tiff","webp","avif","heic","ico","tga","exr","hdr","raw","cr2","nef","arw","dng","orf"]},
  "Vector & Design":{icon:"‚úèÔ∏è",exts:["svg","svgz","ai","eps","wmf","afdesign","sketch","fig","xd","psd","xcf","kra","sai","cdr"]},
  "Video":{icon:"üé¨",exts:["mp4","m4v","mkv","avi","mov","wmv","flv","webm","ogv","3gp","ts","mpg","mpeg","asf","rm"]},
  "Audio":{icon:"üéµ",exts:["mp3","m4a","aac","flac","wav","aiff","ogg","opus","wma","mid","midi","caf","ac3","amr"]},
  "Archives":{icon:"üì¶",exts:["zip","tar","gz","tgz","bz2","xz","zst","7z","rar","cab","iso","dmg","deb","rpm","apk","ipa","jar"]},
  "Fonts":{icon:"üî§",exts:["ttf","otf","woff","woff2","eot","pfb","fnt","bdf","sfd","dfont","ttc"]},
  "3D & CAD":{icon:"üé≤",exts:["obj","fbx","dae","gltf","glb","stl","ply","3ds","blend","step","scad","3mf","wrl","usd","usdz"]},
  "Certificates":{icon:"üîê",exts:["pem","crt","cer","csr","der","pfx","key","pub","gpg","pgp","jwt","p12"]},
  "Binary":{icon:"üìã",exts:["bin","dat","raw","hex","exe","dll","so","dylib","lib","dmp","tmp","bak","lnk","vcf","ics"]}
};

// Magic bytes for file identification
const MAGIC=[
  {sig:[0xFF,0xD8,0xFF],name:"JPEG Image",icon:"üñºÔ∏è"},
  {sig:[0x89,0x50,0x4E,0x47],name:"PNG Image",icon:"üñºÔ∏è"},
  {sig:[0x47,0x49,0x46],name:"GIF Image",icon:"üñºÔ∏è"},
  {sig:[0x25,0x50,0x44,0x46],name:"PDF Document",icon:"üìÑ"},
  {sig:[0x50,0x4B,0x03,0x04],name:"ZIP Archive",icon:"üì¶"},
  {sig:[0x52,0x61,0x72,0x21],name:"RAR Archive",icon:"üì¶"},
  {sig:[0x1F,0x8B],name:"GZIP Archive",icon:"üì¶"},
  {sig:[0x37,0x7A,0xBC,0xAF],name:"7-Zip Archive",icon:"üì¶"},
  {sig:[0x4D,0x54,0x68,0x64],name:"MIDI Audio",icon:"üéπ"},
  {sig:[0x49,0x44,0x33],name:"MP3 Audio (ID3)",icon:"üéµ"},
  {sig:[0xFF,0xFB],name:"MP3 Audio",icon:"üéµ"},
  {sig:[0x66,0x4C,0x61,0x43],name:"FLAC Audio",icon:"üéµ"},
  {sig:[0x52,0x49,0x46,0x46],name:"WAV/AVI File",icon:"üéµ"},
  {sig:[0x00,0x00,0x00,0x18,0x66,0x74,0x79,0x70],name:"MP4 Video",icon:"üé¨"},
  {sig:[0x1A,0x45,0xDF,0xA3],name:"MKV/WebM Video",icon:"üé¨"},
  {sig:[0x4F,0x67,0x67,0x53],name:"OGG Container",icon:"üéµ"},
  {sig:[0x7F,0x45,0x4C,0x46],name:"ELF Executable",icon:"‚öôÔ∏è"},
  {sig:[0x4D,0x5A],name:"Windows Executable",icon:"‚öôÔ∏è"},
  {sig:[0xCA,0xFE,0xBA,0xBE],name:"Java Class File",icon:"‚òï"},
  {sig:[0x00,0x01,0x00,0x00,0x00],name:"TrueType Font",icon:"üî§"},
  {sig:[0x4F,0x54,0x54,0x4F],name:"OpenType Font",icon:"üî§"},
  {sig:[0x77,0x4F,0x46,0x46],name:"WOFF Font",icon:"üî§"},
  {sig:[0x77,0x4F,0x46,0x32],name:"WOFF2 Font",icon:"üî§"},
  {sig:[0x47,0x4C,0x42],name:"GLB 3D Model",icon:"üé≤"},
  {sig:[0x53,0x51,0x4C,0x69],name:"SQLite Database",icon:"üóÑÔ∏è"},
  {sig:[0xD0,0xCF,0x11,0xE0],name:"Office Document (DOC/XLS)",icon:"üìÑ"},
];

// ‚îÄ‚îÄ BUILD UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let total=0;
const scats=document.getElementById('sidebar-cats');
const cstrip=document.getElementById('cat-strip');
Object.entries(EXTS).forEach(([cat,d])=>{
  total+=d.exts.length;
  const div=document.createElement('div');
  div.innerHTML=`<div class="sl">${d.icon} ${cat}</div><div class="si-item" data-cat="${cat}"><span class="ico">${d.icon}</span><span>${cat}</span><span class="cnt">${d.exts.length}</span></div>`;
  scats.appendChild(div);
  const chip=document.createElement('div');
  chip.className='cat-chip';chip.dataset.cat=cat;
  chip.innerHTML=`<span>${d.icon}</span><span>${cat}</span>`;
  chip.addEventListener('click',()=>{
    document.querySelectorAll('.cat-chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');showGrid(cat);
  });
  cstrip.appendChild(chip);
});
document.querySelectorAll('.si-item[data-cat]').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll('.si-item').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');showGrid(el.dataset.cat);
  });
});

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSearch(){
  const b=document.getElementById('search-bar'),btn=document.getElementById('btn-search');
  const open=b.classList.toggle('open');
  btn.classList.toggle('active',open);
  if(open)setTimeout(()=>document.getElementById('sbox').focus(),260);
  else clearSearch();
}
function clearSearch(){
  document.getElementById('sbox').value='';
  document.getElementById('sclear').classList.remove('vis');
  filterCats('');
}
document.getElementById('sbox').addEventListener('input',function(){
  const q=this.value.toLowerCase().trim();
  document.getElementById('sclear').classList.toggle('vis',q.length>0);
  filterCats(q);
});
function filterCats(q){
  let first=null;
  Object.entries(EXTS).forEach(([cat,d])=>{
    const ok=!q||cat.toLowerCase().includes(q)||d.exts.some(e=>e.includes(q));
    const si=document.querySelector(`.si-item[data-cat="${cat}"]`);
    if(si)si.closest('div').style.display=ok?'':'none';
    const ch=document.querySelector(`.cat-chip[data-cat="${cat}"]`);
    if(ch)ch.style.display=ok?'':'none';
    if(!first&&q&&d.exts.includes(q))first=cat;
  });
  if(first)showGrid(first);
}

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTheme(){
  const light=document.body.classList.toggle('light');
  document.getElementById('btn-theme').textContent=light?'üåû':'üåô';
  localStorage.setItem('theme',light?'light':'dark');
}
if(localStorage.getItem('theme')==='light'){document.body.classList.add('light');document.getElementById('btn-theme').textContent='üåû';}

// ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPanel(id){
  if(id==='recent')renderRecent();
  document.getElementById('panel-'+id).classList.add('open');
}
function closePanel(id){document.getElementById('panel-'+id).classList.remove('open');}

// ‚îÄ‚îÄ TOOLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTool(name){
  closePanel('tools');
  openViewer();
  document.getElementById('vbadge').textContent='üîß';
  document.getElementById('vname').textContent=name.charAt(0).toUpperCase()+name.slice(1);
  document.getElementById('tbtn-copy').style.display='none';
  document.getElementById('tbtn-dl').style.display='none';
  document.getElementById('tbtn-full').style.display='none';
  document.getElementById('sfile').textContent='Tool: '+name;
  const body=document.getElementById('vbody');
  if(name==='converter')renderConverter(body);
  else if(name==='diff')renderDiff(body);
  else if(name==='hash')renderHash(body);
  else if(name==='qr')renderQR(body);
  else if(name==='text')renderTextTools(body);
  else if(name==='img-edit')renderImgEdit(body);
}

// ‚îÄ‚îÄ RECENT FILES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let recentFiles=JSON.parse(localStorage.getItem('recent')||'[]');
function addRecent(file){
  const entry={name:file.name,size:file.size,type:file.type||'',time:Date.now()};
  recentFiles=recentFiles.filter(r=>r.name!==file.name);
  recentFiles.unshift(entry);
  if(recentFiles.length>10)recentFiles.pop();
  localStorage.setItem('recent',JSON.stringify(recentFiles));
  const badge=document.getElementById('btn-recent');
  if(recentFiles.length>0&&!badge.querySelector('.badge')){
    const b=document.createElement('div');b.className='badge';b.textContent=recentFiles.length;
    badge.appendChild(b);
  }
}
function renderRecent(){
  const el=document.getElementById('recent-list');
  if(!recentFiles.length){el.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted);font-family:\'JetBrains Mono\',monospace;font-size:12px">No recent files</div>';return;}
  el.innerHTML=recentFiles.map((f,i)=>`
    <div class="recent-item">
      <div class="ri-icon">${getFileIcon(f.name.split('.').pop()||'')}</div>
      <div class="ri-info">
        <div class="ri-name">${esc(f.name)}</div>
        <div class="ri-meta">${fmtSize(f.size)} ¬∑ ${timeAgo(f.time)}</div>
      </div>
      <button class="ri-del" onclick="deleteRecent(${i})">üóë</button>
    </div>`).join('');
}
function deleteRecent(i){recentFiles.splice(i,1);localStorage.setItem('recent',JSON.stringify(recentFiles));renderRecent();}
function timeAgo(t){const s=Math.floor((Date.now()-t)/1000);if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}
function getFileIcon(ext){
  const m={jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',png:'üñºÔ∏è',gif:'üñºÔ∏è',svg:'‚úèÔ∏è',mp4:'üé¨',mov:'üé¨',mkv:'üé¨',mp3:'üéµ',wav:'üéµ',flac:'üéµ',pdf:'üìÑ',doc:'üìÑ',docx:'üìÑ',xls:'üìä',xlsx:'üìä',csv:'üìä',json:'üìã',py:'üêç',js:'üåê',ts:'üåê',html:'üåê',css:'üåê',zip:'üì¶',tar:'üì¶',gz:'üì¶',ttf:'üî§',otf:'üî§',gpx:'üó∫Ô∏è',kml:'üó∫Ô∏è',glb:'üé≤',gltf:'üé≤',stl:'üé≤',mid:'üéπ',midi:'üéπ'};
  return m[ext]||'üìã';
}

// ‚îÄ‚îÄ GRID VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showGrid(cat){
  const d=EXTS[cat];
  openViewer();
  document.getElementById('vbadge').textContent=d.icon;
  document.getElementById('vname').textContent=cat;
  document.getElementById('tbtn-copy').style.display='none';
  document.getElementById('tbtn-dl').style.display='none';
  document.getElementById('sfile').textContent=cat;
  document.getElementById('senc').textContent=d.exts.length+' types';
  let html='<div class="ext-grid">';
  d.exts.forEach(e=>html+=`<div class="ext-chip">.${e}</div>`);
  html+='</div>';
  document.getElementById('vbody').innerHTML=html;
}

// ‚îÄ‚îÄ FILE HANDLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dz=document.getElementById('dz');
const fi=document.getElementById('fi');
let objUrl=null,currentFile=null;

dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag-over');if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0]);});
fi.addEventListener('change',()=>{if(fi.files[0])loadFile(fi.files[0]);fi.value='';});

function openViewer(){
  dz.style.display='none';
  document.getElementById('vwrap').classList.add('active');
  document.getElementById('tbtn-copy').style.display='';
  document.getElementById('tbtn-dl').style.display='';
  document.getElementById('tbtn-full').style.display='';
  // Share API
  document.getElementById('tbtn-share').style.display=navigator.share?'':'none';
}
function closeViewer(){
  document.getElementById('vwrap').classList.remove('active');
  dz.style.display='';
  document.querySelectorAll('.si-item,.cat-chip').forEach(x=>x.classList.remove('active'));
  document.getElementById('sfile').textContent='No file loaded';
  document.getElementById('senc').textContent='';
  document.getElementById('slines').textContent='';
  if(objUrl){URL.revokeObjectURL(objUrl);objUrl=null;}
  window._ct=null;currentFile=null;
}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';if(b<1073741824)return(b/1048576).toFixed(1)+'MB';return(b/1073741824).toFixed(2)+'GB';}

async function loadFile(file){
  currentFile=file;
  addRecent(file);
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  const mime=file.type||'';
  if(objUrl){URL.revokeObjectURL(objUrl);objUrl=null;}
  openViewer();
  document.getElementById('vbadge').textContent=(ext||'?').toUpperCase();
  document.getElementById('vname').textContent=file.name;
  document.getElementById('sfile').textContent=file.name;
  document.getElementById('senc').textContent=fmtSize(file.size);
  document.getElementById('slines').textContent='';
  document.getElementById('vbody').innerHTML='';
  window._ct=null;
  const dlBtn=document.getElementById('tbtn-dl');
  dlBtn.textContent='‚Üì';dlBtn.onclick=()=>{const a=document.createElement('a');a.href=URL.createObjectURL(file);a.download=file.name;a.click();};
  const body=document.getElementById('vbody');

  if(mime.startsWith('image/')||['jpg','jpeg','png','gif','bmp','webp','avif','ico','tiff','tif'].includes(ext)){
    if(ext==='ico')renderICO(file,body);
    else renderImage(file,body,ext);
  } else if(mime.startsWith('video/')||['mp4','webm','ogv','mov','avi','mkv','m4v','3gp'].includes(ext)){renderVideo(file,body);}
  else if(mime.startsWith('audio/')||['mp3','wav','flac','ogg','m4a','aac','opus','wma'].includes(ext)){renderAudio(file,body);}
  else if(ext==='pdf'||mime==='application/pdf'){renderPDF(file,body);}
  else if(['csv','tsv','psv'].includes(ext)){renderCSV(file,body,ext);}
  else if(['xlsx','xls','xlsm','ods'].includes(ext)){renderXLSX(file,body);}
  else if(['docx','doc'].includes(ext)){renderDOCX(file,body);}
  else if(['gpx','kml','kmz'].includes(ext)){renderGPX(file,body,ext);}
  else if(ext==='geojson'||(ext==='json'&&file.name.toLowerCase().includes('geo'))){renderGeoJSON(file,body);}
  else if(['json','jsonc','json5','jsonl'].includes(ext)){renderJSON(file,body);}
  else if(['gltf','glb'].includes(ext)){renderGLTF(file,body,ext);}
  else if(['stl','obj'].includes(ext)){render3D(file,body,ext);}
  else if(['mid','midi'].includes(ext)){renderMIDI(file,body);}
  else if(['md','mdx','markdown'].includes(ext)){renderMarkdown(file,body);}
  else if(ext==='svg'){renderSVG(file,body);}
  else if(['ttf','otf','woff','woff2','eot'].includes(ext)){renderFont(file,body);}
  else if(['zip','jar','apk','ipa'].includes(ext)){renderZIP(file,body);}
  else if(isText(ext,mime)){renderCode(file,body,ext);}
  else{renderHex(file,body);}
}

function isText(ext,mime){
  if(mime.startsWith('text/'))return true;
  return new Set(['txt','log','md','rst','xml','html','htm','css','scss','js','mjs','jsx','ts','tsx','json','yaml','yml','toml','ini','cfg','conf','env','sh','bash','zsh','bat','cmd','ps1','py','rb','go','rs','java','kt','c','cpp','h','cs','php','sql','r','lua','ex','erl','hs','ml','nim','zig','asm','vue','svelte','graphql','tex','makefile','dockerfile','gitignore','editorconfig','proto','wsdl','xsd']).has(ext);
}

// ‚îÄ‚îÄ RENDERERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderImage(file,body,ext){
  objUrl=URL.createObjectURL(file);
  // Read EXIF for images
  const reader=new FileReader();
  reader.onload=e=>{
    const exif=parseEXIF(new DataView(e.target.result));
    let exifHtml='';
    if(Object.keys(exif).length){
      exifHtml=`<div class="exif-wrap">${Object.entries(exif).map(([k,v])=>`<div class="exif-card"><div class="exif-label">${esc(k)}</div><div class="exif-val">${esc(String(v))}</div></div>`).join('')}</div>`;
    }
    body.innerHTML=`<div style="display:flex;flex-direction:column;min-height:100%">
      <div class="image-viewer"><img src="${objUrl}" alt="" id="main-img" onload="document.getElementById('slines').textContent=this.naturalWidth+'√ó'+this.naturalHeight"></div>
      ${exifHtml}
    </div>`;
    // Extract color palette after image loads
    const img=body.querySelector('#main-img');
    img.addEventListener('load',()=>extractPalette(img,body),{once:true});
  };
  reader.readAsArrayBuffer(file.slice(0,65536));
  document.getElementById('senc').textContent=file.type||ext.toUpperCase();
}

function parseEXIF(view){
  const exif={};
  try{
    if(view.getUint16(0)!==0xFFD8)return exif;
    let offset=2;
    while(offset<view.byteLength){
      const marker=view.getUint16(offset);
      if(marker===0xFFE1){
        const len=view.getUint16(offset+2);
        const str=String.fromCharCode(...new Uint8Array(view.buffer,offset+4,4));
        if(str==='Exif'){
          const tiff=offset+10;
          const endian=view.getUint16(tiff);
          const le=endian===0x4949;
          const ifdOffset=view.getUint32(tiff+4,le);
          const entries=view.getUint16(tiff+ifdOffset,le);
          const tags={0x010F:'Make',0x0110:'Model',0x0112:'Orientation',0x011A:'XResolution',0x011B:'YResolution',0x0128:'ResolutionUnit',0x0131:'Software',0x0132:'DateTime',0x8827:'ISO',0x829A:'ExposureTime',0x829D:'FNumber',0x9003:'DateTimeOriginal',0x9286:'UserComment',0xA002:'PixelXDimension',0xA003:'PixelYDimension',0x8825:'GPS'};
          for(let i=0;i<entries;i++){
            const e=tiff+ifdOffset+2+i*12;
            const tag=view.getUint16(e,le);
            const type=view.getUint16(e+2,le);
            const count=view.getUint32(e+4,le);
            if(tags[tag]){
              let val='';
              if(type===2){// ASCII
                const o=count<=4?e+8:tiff+view.getUint32(e+8,le);
                val=String.fromCharCode(...new Uint8Array(view.buffer,o,count-1)).trim();
              } else if(type===3){val=view.getUint16(e+8,le);}
              else if(type===4){val=view.getUint32(e+8,le);}
              else if(type===5){// Rational
                const o=tiff+view.getUint32(e+8,le);
                val=(view.getUint32(o,le)/view.getUint32(o+4,le)).toFixed(4);
              }
              if(val!==''&&val!==0&&val!=='0.0000')exif[tags[tag]]=val;
            }
          }
        }
        break;
      }
      if((marker&0xFF00)!==0xFF00)break;
      offset+=2+view.getUint16(offset+2);
    }
  }catch(e){}
  return exif;
}

function extractPalette(img,body){
  try{
    const c=document.createElement('canvas');
    const s=80;c.width=s;c.height=s;
    const ctx=c.getContext('2d');
    ctx.drawImage(img,0,0,s,s);
    const d=ctx.getImageData(0,0,s,s).data;
    const buckets={};
    for(let i=0;i<d.length;i+=4){
      if(d[i+3]<128)continue;
      const r=Math.round(d[i]/32)*32,g=Math.round(d[i+1]/32)*32,b=Math.round(d[i+2]/32)*32;
      const k=`${r},${g},${b}`;
      buckets[k]=(buckets[k]||0)+1;
    }
    const top=Object.entries(buckets).sort((a,b)=>b[1]-a[1]).slice(0,8);
    if(!top.length)return;
    const palHtml=`<div class="palette-wrap"><div style="font-size:12px;font-weight:700;margin-bottom:12px;color:var(--muted)">COLOR PALETTE</div><div class="palette-colors">${top.map(([k])=>{const[r,g,b]=k.split(',');const hex='#'+[r,g,b].map(x=>parseInt(x).toString(16).padStart(2,'0')).join('');return`<div class="pal-swatch" onclick="navigator.clipboard&&navigator.clipboard.writeText('${hex}')"><div class="pal-color" style="background:${hex}"></div><div class="pal-hex">${hex}</div></div>`}).join('')}</div></div>`;
    body.querySelector('div').insertAdjacentHTML('beforeend',palHtml);
  }catch(e){}
}

function renderICO(file,body){
  const reader=new FileReader();
  reader.onload=e=>{
    const buf=new DataView(e.target.result);
    const count=buf.getUint16(4,true);
    let html=`<div class="ico-viewer"><div style="font-size:13px;font-weight:700;margin-bottom:8px">ICO contains ${count} size(s)</div><div class="ico-sizes">`;
    for(let i=0;i<count;i++){
      const w=buf.getUint8(6+i*16)||256;
      const h=buf.getUint8(7+i*16)||256;
      const offset=buf.getUint32(18+i*16,true);
      const size2=buf.getUint32(14+i*16,true);
      const imgData=new Uint8Array(e.target.result,offset,size2);
      const blob=new Blob([imgData],{type:'image/png'});
      const url=URL.createObjectURL(blob);
      html+=`<div class="ico-size-wrap"><img src="${url}" width="${Math.min(w,64)}" height="${Math.min(h,64)}" style="border:1px solid var(--border);border-radius:4px;background:repeating-conic-gradient(rgba(255,255,255,.05) 0% 25%,transparent 0% 50%) 0 0/8px 8px"><div class="ico-label">${w}√ó${h}</div></div>`;
    }
    html+='</div></div>';
    body.innerHTML=html;
    document.getElementById('senc').textContent='ICO';
    document.getElementById('slines').textContent=count+' sizes';
  };
  reader.readAsArrayBuffer(file);
}

function renderVideo(file,body){
  objUrl=URL.createObjectURL(file);
  body.innerHTML=`<div class="video-wrap">
    <div class="video-main"><video id="main-vid" controls playsinline src="${objUrl}"></video></div>
    <div class="thumb-strip" id="thumb-strip"></div>
  </div>`;
  const vid=body.querySelector('#main-vid');
  vid.addEventListener('loadedmetadata',()=>{
    document.getElementById('slines').textContent=Math.floor(vid.duration/60)+':'+String(Math.floor(vid.duration%60)).padStart(2,'0');
    generateThumbs(vid);
  });
}
function generateThumbs(vid){
  const strip=document.getElementById('thumb-strip');
  if(!strip)return;
  const count=10;const dur=vid.duration;
  const c=document.createElement('canvas');c.width=160;c.height=90;
  const ctx=c.getContext('2d');
  let i=0;
  const next=()=>{
    if(i>=count||!strip)return;
    const t=(i+0.5)*(dur/count);
    vid.currentTime=t;
    vid.addEventListener('seeked',()=>{
      ctx.drawImage(vid,0,0,160,90);
      const img=document.createElement('img');
      img.className='thumb';img.src=c.toDataURL();
      const ti=i;
      img.addEventListener('click',()=>{
        vid.currentTime=(ti+0.5)*(dur/count);
        document.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active'));
        img.classList.add('active');
      });
      strip.appendChild(img);
      i++;next();
    },{once:true});
  };
  next();
}

function renderAudio(file,body){
  objUrl=URL.createObjectURL(file);
  body.innerHTML=`<div class="waveform-wrap">
    <div class="waveform-canvas-wrap"><canvas id="wave-canvas" height="120"></canvas></div>
    <div class="waveform-player" style="display:flex;flex-direction:column;gap:10px">
      <div style="font-size:14px;font-weight:700;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(file.name)}</div>
      <audio controls src="${objUrl}" style="width:100%" id="main-audio"></audio>
    </div>
  </div>`;
  document.getElementById('senc').textContent='Audio';
  // Draw waveform
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const actx=new(window.AudioContext||window.webkitAudioContext)();
      const decoded=await actx.decodeAudioData(e.target.result);
      const canvas=document.getElementById('wave-canvas');
      if(!canvas)return;
      const w=canvas.parentElement.clientWidth;canvas.width=w;
      const ctx2=canvas.getContext('2d');
      const data=decoded.getChannelData(0);
      const step=Math.floor(data.length/w);
      const h=120;
      ctx2.fillStyle=getComputedStyle(document.body).getPropertyValue('--surface2').trim()||'#16161f';
      ctx2.fillRect(0,0,w,h);
      const grad=ctx2.createLinearGradient(0,0,w,0);
      grad.addColorStop(0,'#6ee7f7');grad.addColorStop(0.5,'#b47aff');grad.addColorStop(1,'#6ee7f7');
      ctx2.strokeStyle=grad;ctx2.lineWidth=1;ctx2.beginPath();
      for(let x=0;x<w;x++){
        let min=1,max=-1;
        for(let j=0;j<step;j++){const s=data[x*step+j]||0;if(s<min)min=s;if(s>max)max=s;}
        ctx2.moveTo(x,((1+min)/2)*h);ctx2.lineTo(x,((1+max)/2)*h);
      }
      ctx2.stroke();
      document.getElementById('slines').textContent=decoded.duration.toFixed(1)+'s';
    }catch(err){
      const canvas=document.getElementById('wave-canvas');
      if(canvas){canvas.style.display='none';}
    }
  };
  reader.readAsArrayBuffer(file);
}

function renderPDF(file,body){objUrl=URL.createObjectURL(file);body.innerHTML=`<iframe class="pdf-viewer" src="${objUrl}"></iframe>`;body.style.height='100%';}

function renderCSV(file,body,ext){
  const sep=ext==='tsv'?'\t':ext==='psv'?'|':',';
  readText(file,text=>{
    const rows=text.trim().split('\n').map(r=>csvRow(r,sep));
    if(!rows.length){body.innerHTML='<div style="padding:20px;color:var(--muted)">Empty</div>';return;}
    const hds=rows[0];
    let html=`<div class="table-viewer"><table class="data-table"><thead><tr>${hds.map(h=>`<th>${esc(h)}</th>`).join('')}</tr></thead><tbody>`;
    rows.slice(1).forEach(r=>{html+=`<tr>${r.map(c=>`<td>${esc(c)}</td>`).join('')}</tr>`;});
    html+='</tbody></table></div>';
    body.innerHTML=html;
    document.getElementById('slines').textContent=(rows.length-1)+' rows';
    document.getElementById('senc').textContent=ext.toUpperCase();
    window._ct=text;
  });
}
function csvRow(row,sep){const r=[];let c='',q=false;for(let i=0;i<row.length;i++){const ch=row[i];if(ch==='"'){q=!q;continue;}if(ch===sep&&!q){r.push(c);c='';continue;}c+=ch;}r.push(c);return r;}

function renderJSON(file,body){
  readText(file,text=>{
    let p=text;try{p=JSON.stringify(JSON.parse(text),null,2);}catch(e){}
    window._ct=p;
    document.getElementById('slines').textContent=p.split('\n').length+' lines';
    document.getElementById('senc').textContent='JSON';
    body.innerHTML='<div class="json-viewer">'+colorJSON(p)+'</div>';
  });
}
function colorJSON(t){return esc(t).replace(/"([^"]+)":/g,'<span class="jk">"$1"</span>:').replace(/: "([^"]*)"/g,': <span class="js">"$1"</span>').replace(/: (-?\d+\.?\d*)/g,': <span class="jn">$1</span>').replace(/: (true|false)/g,': <span class="jb">$1</span>').replace(/: (null)/g,': <span class="jnull">$1</span>');}

function renderMarkdown(file,body){
  readText(file,text=>{
    window._ct=text;
    document.getElementById('slines').textContent=text.split('\n').length+' lines';
    body.innerHTML='<div class="md-viewer">'+parseMD(text)+'</div>';
  });
}
function parseMD(md){
  let h=esc(md);
  h=h.replace(/```[\w]*\n([\s\S]*?)```/g,'<pre><code>$1</code></pre>');
  h=h.replace(/`([^`]+)`/g,'<code>$1</code>');
  h=h.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  h=h.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  h=h.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  h=h.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*([^*]+)\*/g,'<em>$1</em>');
  h=h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>');
  h=h.replace(/^---+$/gm,'<hr>');
  h=h.replace(/^[-*+] (.+)$/gm,'<li>$1</li>');
  h=h.replace(/(<li>[\s\S]+?<\/li>)/g,'<ul>$1</ul>');
  h=h.replace(/^&gt; (.+)$/gm,'<blockquote>$1</blockquote>');
  h=h.replace(/\n\n/g,'</p><p>');
  return '<p>'+h+'</p>';
}

function renderSVG(file,body){
  readText(file,text=>{
    window._ct=text;
    body.innerHTML=`<div class="svg-editor">
      <div class="svg-code"><textarea id="svg-ta" oninput="updateSVGPreview()">${esc(text)}</textarea></div>
      <div class="svg-preview" id="svg-prev">${text}</div>
    </div>`;
    document.getElementById('senc').textContent='SVG Live Editor';
  });
}
function updateSVGPreview(){
  const ta=document.getElementById('svg-ta');
  const prev=document.getElementById('svg-prev');
  if(ta&&prev){prev.innerHTML=ta.value;window._ct=ta.value;}
}

function renderFont(file,body){
  const reader=new FileReader();
  reader.onload=e=>{
    const fontName='pfont-'+Date.now();
    const blob=new Blob([e.target.result]);
    objUrl=URL.createObjectURL(blob);
    const styleEl=document.createElement('style');
    styleEl.textContent=`@font-face{font-family:'${fontName}';src:url('${objUrl}');}`;
    document.head.appendChild(styleEl);
    document.getElementById('senc').textContent='Font';
    document.getElementById('slines').textContent=file.name;

    body.innerHTML=`<div class="font-viewer">
      <!-- Live type area -->
      <div style="background:var(--surface);border:1px solid var(--accent);border-radius:10px;padding:16px;margin-bottom:4px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">
          <div style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--accent);font-weight:700">‚úèÔ∏è TYPE IN THIS FONT</div>
          <input type="range" id="font-size-slider" min="14" max="120" value="48" style="accent-color:var(--accent);flex:1;min-width:80px" oninput="updateFontSize(this.value)">
          <span id="font-size-label" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);width:40px">48px</span>
          <input type="color" id="font-color" value="#e8e8f0" style="width:32px;height:28px;border:1px solid var(--border);border-radius:4px;cursor:pointer;background:none" oninput="updateFontColor(this.value)">
        </div>
        <div id="font-type-area"
          contenteditable="true"
          spellcheck="false"
          style="font-family:'${fontName}';font-size:48px;min-height:80px;outline:none;word-break:break-all;line-height:1.3;color:#e8e8f0;cursor:text;"
          placeholder="Type here‚Ä¶"
          oninput="updateFontDisplay()">The quick brown fox</div>
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button class="tbtn" onclick="copyFontAsImage('${fontName}')">üìã Copy as Image</button>
          <button class="tbtn" onclick="downloadFontImage('${fontName}')">‚Üì Download PNG</button>
          <button class="tbtn" onclick="copyFontText()">Copy Text</button>
          <span id="font-copy-msg" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--success);align-self:center;opacity:0;transition:opacity .3s"></span>
        </div>
      </div>

      <!-- Font previews at different sizes -->
      <div style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);padding:4px 0 8px;letter-spacing:1px">PREVIEW SIZES</div>
      ${[{s:'48px',t:'Aa Bb Cc Dd'},{s:'32px',t:'The quick brown fox jumps over the lazy dog'},{s:'20px',t:'ABCDEFGHIJKLMNOPQRSTUVWXYZ'},{s:'16px',t:'abcdefghijklmnopqrstuvwxyz'},{s:'14px',t:'0123456789 !@#$%^&*()_+-=[]{}|;:\'",.<>?/`~'}].map(({s,t})=>`
        <div class="font-preview">
          <div class="fps">${s}</div>
          <div style="font-family:'${fontName}';font-size:${s};line-height:1.4;word-break:break-word">${esc(t)}</div>
        </div>`).join('')}
    </div>`;

    // Store font name globally for copy functions
    window._currentFontName=fontName;
  };
  reader.readAsArrayBuffer(file);
}

function updateFontSize(val){
  const area=document.getElementById('font-type-area');
  const label=document.getElementById('font-size-label');
  if(area)area.style.fontSize=val+'px';
  if(label)label.textContent=val+'px';
}
function updateFontColor(val){
  const area=document.getElementById('font-type-area');
  if(area)area.style.color=val;
}
function updateFontDisplay(){}

function copyFontText(){
  const area=document.getElementById('font-type-area');
  if(!area)return;
  navigator.clipboard.writeText(area.innerText||area.textContent).then(()=>showFontMsg('Text copied!'));
}

function copyFontAsImage(fontName){
  renderFontToCanvas(fontName,(canvas)=>{
    canvas.toBlob(blob=>{
      try{
        const item=new ClipboardItem({'image/png':blob});
        navigator.clipboard.write([item]).then(()=>showFontMsg('Image copied to clipboard!')).catch(()=>{
          // Fallback: download
          downloadFromBlob(blob,'font-text.png');showFontMsg('Downloaded (clipboard blocked)');
        });
      }catch(e){downloadFromBlob(blob,'font-text.png');showFontMsg('Downloaded PNG');}
    },'image/png');
  });
}

function downloadFontImage(fontName){
  renderFontToCanvas(fontName,(canvas)=>{
    canvas.toBlob(blob=>{downloadFromBlob(blob,'font-text.png');showFontMsg('Downloaded!');});
  });
}

function renderFontToCanvas(fontName,callback){
  const area=document.getElementById('font-type-area');
  if(!area)return;
  const text=area.innerText||area.textContent||'';
  const fontSize=parseInt(area.style.fontSize)||48;
  const color=area.style.color||'#e8e8f0';
  const padding=20;
  // Measure
  const mc=document.createElement('canvas');
  const mctx=mc.getContext('2d');
  mctx.font=`${fontSize}px '${fontName}'`;
  const lines=text.split('\n');
  const lineH=fontSize*1.4;
  const maxW=Math.max(...lines.map(l=>mctx.measureText(l||' ').width));
  const canvW=Math.ceil(maxW+padding*2);
  const canvH=Math.ceil(lines.length*lineH+padding*2);
  const c=document.createElement('canvas');
  c.width=Math.max(canvW,200);c.height=Math.max(canvH,80);
  const ctx=c.getContext('2d');
  // Background
  ctx.fillStyle=document.body.classList.contains('light')?'#f4f4f8':'#0a0a0f';
  ctx.fillRect(0,0,c.width,c.height);
  // Text
  ctx.font=`${fontSize}px '${fontName}'`;
  ctx.fillStyle=color;
  ctx.textBaseline='top';
  lines.forEach((line,i)=>ctx.fillText(line||'',padding,padding+i*lineH));
  callback(c);
}

function showFontMsg(msg){
  const el=document.getElementById('font-copy-msg');
  if(!el)return;
  el.textContent=msg;el.style.opacity='1';
  setTimeout(()=>el.style.opacity='0',2000);
}
function downloadFromBlob(blob,name){
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();
}

function renderCode(file,body,ext){
  readText(file,text=>{
    window._ct=text;
    const lines=text.split('\n');
    document.getElementById('slines').textContent=lines.length+' lines';
    document.getElementById('senc').textContent='UTF-8';
    const hl=synHL(text,ext).split('\n');
    let html='';
    hl.forEach((l,i)=>{html+=`<div class="code-line"><span class="ln">${i+1}</span><span class="lc">${l||' '}</span></div>`;});
    body.innerHTML=`<pre class="code-viewer">${html}</pre>`;
  });
}

function renderHex(file,body){
  const reader=new FileReader();
  reader.onload=async e=>{
    const buf=new Uint8Array(e.target.result);
    // Identify file by magic bytes
    const magic=identifyMagic(buf);
    document.getElementById('senc').textContent='Binary';
    document.getElementById('slines').textContent=buf.length+'B shown';
    let magicHtml='';
    if(magic){
      magicHtml=`<div class="magic-wrap"><div class="magic-card"><div class="magic-icon">${magic.icon}</div><div><div class="magic-detected">${magic.name}</div><div class="magic-sig">Magic bytes: ${Array.from(buf.slice(0,magic.sig.length)).map(b=>'0x'+b.toString(16).padStart(2,'0').toUpperCase()).join(' ')}</div><div class="magic-confidence">High confidence</div></div></div></div>`;
    }
    let hexHtml='<div class="hex-viewer">';
    for(let i=0;i<buf.length;i+=16){
      const row=buf.slice(i,i+16);
      const addr=i.toString(16).padStart(8,'0').toUpperCase();
      const bytes=Array.from(row).map(b=>b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
      const ascii=Array.from(row).map(b=>(b>=32&&b<127)?esc(String.fromCharCode(b)):'¬∑').join('');
      hexHtml+=`<div class="hex-row"><span class="hxa">${addr}</span><span class="hxb">${bytes}</span><span class="hxc">${ascii}</span></div>`;
    }
    if(file.size>4096)hexHtml+=`<div style="padding:10px;color:var(--muted);font-size:11px;font-family:'JetBrains Mono',monospace">‚Ä¶first 4KB of ${fmtSize(file.size)}</div>`;
    hexHtml+='</div>';
    body.innerHTML=magicHtml+hexHtml;
  };
  reader.readAsArrayBuffer(file.slice(0,4096));
}

function identifyMagic(buf){
  for(const m of MAGIC){
    if(m.sig.every((b,i)=>buf[i]===b))return m;
  }
  return null;
}

// ‚îÄ‚îÄ ZIP BROWSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderZIP(file,body){
  body.innerHTML=`<div style="padding:20px;text-align:center;color:var(--muted);font-family:'JetBrains Mono',monospace">Reading archive‚Ä¶</div>`;
  try{
    const zip=await JSZip.loadAsync(file);
    const entries=Object.values(zip.files).sort((a,b)=>{
      if(a.dir!==b.dir)return a.dir?-1:1;
      return a.name.localeCompare(b.name);
    });
    let totalSize=0;
    let html=`<div class="zip-list">`;
    // Stats bar
    const files=entries.filter(e=>!e.dir);
    html+=`<div style="padding:10px 14px;background:var(--surface);border-bottom:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);display:flex;gap:16px">
      <span>üì¶ <b style="color:var(--text)">${file.name}</b></span>
      <span>${files.length} files</span>
      <span>${entries.filter(e=>e.dir).length} folders</span>
    </div>`;
    entries.forEach(entry=>{
      const name=entry.name;
      const parts=name.split('/').filter(Boolean);
      const depth=parts.length-1;
      const indent=depth*16;
      if(entry.dir){
        html+=`<div class="zip-folder" style="padding-left:${12+indent}px">üìÅ ${esc(parts[parts.length-1]||name)}/</div>`;
      } else {
        const ext2=(name.split('.').pop()||'').toLowerCase();
        const sz=entry._data?entry._data.uncompressedSize:0;
        if(sz)totalSize+=sz;
        html+=`<div class="zip-file" style="padding-left:${28+indent}px" data-zip-name="${esc(name)}">
          <span>${getFileIcon(ext2)}</span>
          <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(parts[parts.length-1]||name)}</span>
          <span class="zip-size">${sz?fmtSize(sz):''}</span>
          <button class="zip-extract-btn" onclick="extractZipFile(event,'${esc(name)}')">‚Üì</button>
        </div>`;
      }
    });
    html+='</div>';
    body.innerHTML=html;
    document.getElementById('senc').textContent=entries.length+' entries';
    document.getElementById('slines').textContent=totalSize?fmtSize(totalSize):'';
    // Store zip reference for extraction
    window._currentZip=zip;
  }catch(err){
    body.innerHTML=`<div style="padding:20px;color:var(--error);font-family:'JetBrains Mono',monospace">Failed to read archive: ${esc(err.message)}<br><br>Note: encrypted ZIPs are not supported.</div>`;
  }
}
async function extractZipFile(e,name){
  e.stopPropagation();
  const zip=window._currentZip;
  if(!zip)return;
  const btn=e.target;btn.textContent='‚Ä¶';
  try{
    const f=zip.file(name);
    const blob=await f.async('blob');
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=name.split('/').pop();a.click();
    setTimeout(()=>URL.revokeObjectURL(url),1000);
    btn.textContent='‚úì';setTimeout(()=>btn.textContent='‚Üì',1500);
  }catch(err){btn.textContent='‚úó';setTimeout(()=>btn.textContent='‚Üì',1500);}
}

// ‚îÄ‚îÄ GPX / KML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGPX(file,body,ext){
  body.innerHTML=`<div class="map-viewer"><div id="lmap"></div><div class="map-stats" id="mstats">Loading‚Ä¶</div></div>`;
  body.style.height='100%';
  readText(file,text=>{
    const map=L.map('lmap',{zoomControl:true});
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19}).addTo(map);
    const parser=new DOMParser();
    const doc=parser.parseFromString(text,'text/xml');
    const points=[];
    const trkStyle={color:'#6ee7f7',weight:3,opacity:.85};
    if(ext==='gpx'){
      doc.querySelectorAll('trkpt').forEach(pt=>{
        const lat=parseFloat(pt.getAttribute('lat')),lon=parseFloat(pt.getAttribute('lon'));
        const ele=pt.querySelector('ele');
        if(!isNaN(lat)&&!isNaN(lon))points.push([lat,lon,ele?parseFloat(ele.textContent):null]);
      });
      doc.querySelectorAll('wpt').forEach(wpt=>{
        const lat=parseFloat(wpt.getAttribute('lat')),lon=parseFloat(wpt.getAttribute('lon'));
        const name=wpt.querySelector('name')?.textContent||'';
        if(!isNaN(lat)&&!isNaN(lon))L.circleMarker([lat,lon],{radius:6,color:'#b47aff',fillColor:'#b47aff',fillOpacity:1}).bindPopup(name).addTo(map);
      });
      if(points.length>1){
        L.polyline(points.map(p=>[p[0],p[1]]),trkStyle).addTo(map);
        L.circleMarker(points[0],{radius:8,color:'#4ade80',fillColor:'#4ade80',fillOpacity:1}).bindPopup('Start').addTo(map);
        L.circleMarker(points[points.length-1],{radius:8,color:'#f87171',fillColor:'#f87171',fillOpacity:1}).bindPopup('End').addTo(map);
      }
    } else if(ext==='kml'){
      doc.querySelectorAll('Placemark').forEach(pm=>{
        const coords=pm.querySelector('coordinates');
        const name=pm.querySelector('name')?.textContent||'';
        if(!coords)return;
        const parts=coords.textContent.trim().split(/\s+/);
        if(parts.length===1){const[lon,lat]=parts[0].split(',').map(Number);if(!isNaN(lat)&&!isNaN(lon)){L.marker([lat,lon]).bindPopup(name).addTo(map);points.push([lat,lon]);}}
        else{const line=parts.map(p=>{const[lon,lat]=p.split(',').map(Number);return[lat,lon];}).filter(p=>!isNaN(p[0]));if(line.length>1){L.polyline(line,trkStyle).addTo(map);points.push(...line);}}
      });
    }
    if(points.length){
      const ll=points.map(p=>Array.isArray(p[0])?p:[p[0],p[1]]);
      map.fitBounds(L.latLngBounds(ll),{padding:[30,30]});
      let dist=0;for(let i=1;i<ll.length;i++)dist+=L.latLng(ll[i-1]).distanceTo(L.latLng(ll[i]));
      const elevs=points.map(p=>p[2]).filter(e=>e!==null);
      const gain=elevs.length>1?elevs.reduce((acc,e,i)=>i>0&&e>elevs[i-1]?acc+(e-elevs[i-1]):acc,0):null;
      let st=`<span>üìç <span class="msv">${points.length}</span> pts</span>`;
      if(dist>0)st+=`<span>üìè <span class="msv">${dist>=1000?(dist/1000).toFixed(2)+'km':dist.toFixed(0)+'m'}</span></span>`;
      if(gain!==null)st+=`<span>‚õ∞ <span class="msv">+${gain.toFixed(0)}m</span></span>`;
      document.getElementById('mstats').innerHTML=st;
      document.getElementById('senc').textContent=ext.toUpperCase();
      document.getElementById('slines').textContent=points.length+' pts';
    } else {document.getElementById('mstats').textContent='No coordinates found';}
  });
}

function renderGeoJSON(file,body){
  body.innerHTML=`<div class="map-viewer"><div id="lmap"></div><div class="map-stats" id="mstats">Loading‚Ä¶</div></div>`;
  body.style.height='100%';
  readText(file,text=>{
    try{
      const data=JSON.parse(text);
      const map=L.map('lmap');
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19}).addTo(map);
      const layer=L.geoJSON(data,{
        style:{color:'#6ee7f7',weight:2,fillColor:'#b47aff',fillOpacity:.2},
        pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:6,color:'#6ee7f7',fillColor:'#6ee7f7',fillOpacity:.8}),
        onEachFeature:(f,l)=>{if(f.properties){const p=Object.entries(f.properties).map(([k,v])=>`<b>${k}:</b> ${v}`).join('<br>');l.bindPopup(p);}}
      }).addTo(map);
      map.fitBounds(layer.getBounds(),{padding:[20,20]});
      const count=data.features?data.features.length:1;
      document.getElementById('mstats').innerHTML=`<span>üó∫ GeoJSON</span><span>Features: <span class="msv">${count}</span></span>`;
      document.getElementById('senc').textContent='GeoJSON';
      document.getElementById('slines').textContent=count+' features';
    }catch(e){renderJSON(file,body);}
  });
}

// ‚îÄ‚îÄ GLTF / GLB 3D ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGLTF(file,body,ext){
  body.innerHTML=`<div class="model-viewer" id="mwrap">
    <div class="mctrl">
      <button class="mbtn" title="Reset" onclick="resetCam()">‚åÇ</button>
      <button class="mbtn" title="Wireframe" onclick="toggleWF()">‚¨°</button>
      <button class="mbtn" title="Auto-rotate" onclick="toggleAR()">‚Üª</button>
    </div>
    <div class="mhint" id="mhint">Drag ¬∑ Pinch/Scroll to zoom</div>
  </div>`;
  body.style.height='100%';
  const wrap=document.getElementById('mwrap');
  const W=wrap.clientWidth,H=wrap.clientHeight;
  const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.setSize(W,H);
  renderer.outputEncoding=THREE.sRGBEncoding;
  renderer.toneMapping=THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure=1.2;
  renderer.shadowMap.enabled=true;
  wrap.appendChild(renderer.domElement);
  const scene=new THREE.Scene();scene.background=new THREE.Color(0x0d0d14);
  const camera=new THREE.PerspectiveCamera(45,W/H,0.001,1000);
  camera.position.set(0,1,3);
  scene.add(new THREE.AmbientLight(0xffffff,.4));
  const dl=new THREE.DirectionalLight(0x6ee7f7,1.2);dl.position.set(5,10,5);scene.add(dl);
  scene.add(Object.assign(new THREE.DirectionalLight(0xb47aff,.5),{position:new THREE.Vector3(-5,-5,-5)}));
  scene.add(new THREE.GridHelper(20,20,0x2a2a3a,0x1a1a2a));
  let rotX=0,rotY=0,zoom=3,isDrag=false,lastX=0,lastY=0,autoRot=true;
  window._wf=false;
  window.resetCam=()=>{rotX=0;rotY=0;zoom=3;};
  window.toggleWF=()=>{window._wf=!window._wf;scene.traverse(o=>{if(o.isMesh&&o.material){const m=Array.isArray(o.material)?o.material:[o.material];m.forEach(mat=>mat.wireframe=window._wf);}});};
  window.toggleAR=()=>{autoRot=!autoRot;};
  const cv=renderer.domElement;
  cv.addEventListener('mousedown',e=>{isDrag=true;lastX=e.clientX;lastY=e.clientY;});
  window.addEventListener('mouseup',()=>isDrag=false);
  window.addEventListener('mousemove',e=>{if(!isDrag)return;rotY+=(e.clientX-lastX)*.01;rotX+=(e.clientY-lastY)*.01;rotX=Math.max(-Math.PI/2,Math.min(Math.PI/2,rotX));lastX=e.clientX;lastY=e.clientY;autoRot=false;});
  cv.addEventListener('wheel',e=>{zoom=Math.max(.5,Math.min(20,zoom+e.deltaY*.005));e.preventDefault();},{passive:false});
  let ltd=0;
  cv.addEventListener('touchstart',e=>{if(e.touches.length===1){isDrag=true;lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;autoRot=false;}if(e.touches.length===2)ltd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);},{passive:true});
  cv.addEventListener('touchmove',e=>{if(e.touches.length===1&&isDrag){rotY+=(e.touches[0].clientX-lastX)*.012;rotX+=(e.touches[0].clientY-lastY)*.012;rotX=Math.max(-Math.PI/2,Math.min(Math.PI/2,rotX));lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;}if(e.touches.length===2){const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);zoom=Math.max(.5,Math.min(20,zoom-(d-ltd)*.01));ltd=d;}},{passive:true});
  cv.addEventListener('touchend',()=>isDrag=false,{passive:true});
  objUrl=URL.createObjectURL(file);
  const ls=document.createElement('script');
  ls.src='https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js';
  ls.onload=()=>{
    const loader=new THREE.GLTFLoader();
    document.getElementById('senc').textContent='Loading‚Ä¶';
    loader.load(objUrl,gltf=>{
      const model=gltf.scene;
      const box=new THREE.Box3().setFromObject(model);
      const center=box.getCenter(new THREE.Vector3());
      const size=box.getSize(new THREE.Vector3());
      const scale=2/Math.max(size.x,size.y,size.z);
      model.scale.setScalar(scale);
      model.position.sub(center.multiplyScalar(scale));
      model.position.y+=size.y*scale*.5;
      scene.add(model);zoom=2.5;
      document.getElementById('senc').textContent=ext.toUpperCase();
      let mc=0,tc=0;
      model.traverse(o=>{if(o.isMesh){mc++;if(o.geometry.index)tc+=o.geometry.index.count/3;}});
      document.getElementById('slines').textContent=mc+' meshes'+(tc>0?' ¬∑ '+Math.round(tc).toLocaleString()+' tris':'');
    },undefined,err=>{body.innerHTML=`<div style="padding:24px;color:var(--error);font-family:'JetBrains Mono',monospace">Failed: ${err.message}</div>`;});
  };
  document.head.appendChild(ls);
  let animId;
  const animate=()=>{
    animId=requestAnimationFrame(animate);
    if(autoRot)rotY+=.005;
    camera.position.x=Math.sin(rotY)*Math.cos(rotX)*zoom;
    camera.position.y=Math.sin(rotX)*zoom+1;
    camera.position.z=Math.cos(rotY)*Math.cos(rotX)*zoom;
    camera.lookAt(0,.5,0);renderer.render(scene,camera);
  };
  animate();
  const origClose=window.closeViewer;
  window.closeViewer=()=>{cancelAnimationFrame(animId);renderer.dispose();window.closeViewer=origClose;origClose();};
  new ResizeObserver(()=>{const w=wrap.clientWidth,h=wrap.clientHeight;camera.aspect=w/h;camera.updateProjectionMatrix();renderer.setSize(w,h);}).observe(wrap);
}

function render3D(file,body,ext){
  body.innerHTML=`<div class="model-viewer" id="mwrap"><div class="mhint">Drag ¬∑ Scroll to zoom</div></div>`;
  body.style.height='100%';
  const wrap=document.getElementById('mwrap');
  const renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.setSize(wrap.clientWidth,wrap.clientHeight);
  renderer.setClearColor(0x0d0d14);
  wrap.appendChild(renderer.domElement);
  const scene=new THREE.Scene();
  const camera=new THREE.PerspectiveCamera(45,wrap.clientWidth/wrap.clientHeight,.01,1000);
  scene.add(new THREE.AmbientLight(0xffffff,.5));
  const d=new THREE.DirectionalLight(0x6ee7f7,1);d.position.set(1,2,3);scene.add(d);
  scene.add(new THREE.GridHelper(10,10,0x2a2a3a,0x1a1a2a));
  const reader=new FileReader();
  reader.onload=e=>{
    const ls=document.createElement('script');
    ls.src='https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js';
    ls.onload=()=>{
      const loader=new THREE.STLLoader();
      const geo=loader.parse(e.target.result);
      geo.computeVertexNormals();
      const mesh=new THREE.Mesh(geo,new THREE.MeshPhongMaterial({color:0x6ee7f7,shininess:60}));
      const box=new THREE.Box3().setFromObject(mesh);
      const center=box.getCenter(new THREE.Vector3());
      const size=box.getSize(new THREE.Vector3());
      mesh.position.sub(center);
      mesh.scale.setScalar(2/Math.max(size.x,size.y,size.z));
      scene.add(mesh);camera.position.set(0,1,4);
      document.getElementById('senc').textContent='STL';
      document.getElementById('slines').textContent=(geo.attributes.position.count/3).toFixed(0)+' tris';
    };
    document.head.appendChild(ls);
  };
  reader.readAsArrayBuffer(file);
  let isDrag=false,lastX=0,lastY=0,rotX=0,rotY=0,zoom=4;
  const cv=renderer.domElement;
  cv.addEventListener('mousedown',e=>{isDrag=true;lastX=e.clientX;lastY=e.clientY;});
  window.addEventListener('mouseup',()=>isDrag=false);
  window.addEventListener('mousemove',e=>{if(!isDrag)return;rotY+=(e.clientX-lastX)*.01;rotX+=(e.clientY-lastY)*.01;rotX=Math.max(-Math.PI/2,Math.min(Math.PI/2,rotX));lastX=e.clientX;lastY=e.clientY;});
  cv.addEventListener('wheel',e=>{zoom=Math.max(1,Math.min(20,zoom+e.deltaY*.005));e.preventDefault();},{passive:false});
  let animId;
  const animate=()=>{animId=requestAnimationFrame(animate);camera.position.x=Math.sin(rotY)*Math.cos(rotX)*zoom;camera.position.y=Math.sin(rotX)*zoom+.5;camera.position.z=Math.cos(rotY)*Math.cos(rotX)*zoom;camera.lookAt(0,0,0);renderer.render(scene,camera);};
  animate();
  const origClose=window.closeViewer;
  window.closeViewer=()=>{cancelAnimationFrame(animId);renderer.dispose();window.closeViewer=origClose;origClose();};
}

// ‚îÄ‚îÄ XLSX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderXLSX(file,body){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      const names=wb.SheetNames;
      const render=idx=>{
        const ws=wb.Sheets[names[idx]];
        const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
        if(!data.length)return '<div style="padding:20px;color:var(--muted)">Empty sheet</div>';
        const mc=Math.max(...data.map(r=>r.length));
        let h=`<table class="data-table"><thead><tr>${(data[0]||[]).map(c=>`<th>${esc(String(c))}</th>`).join('')}</tr></thead><tbody>`;
        data.slice(1).forEach(r=>{h+=`<tr>${Array.from({length:mc},(_,i)=>`<td>${esc(String(r[i]||''))}</td>`).join('')}</tr>`;});
        return h+'</tbody></table>';
      };
      const tabs=names.map((n,i)=>`<div class="stab${i===0?' active':''}" onclick="switchSheet(${i})">${esc(n)}</div>`).join('');
      body.innerHTML=`<div class="xlsx-viewer"><div class="sheet-tabs">${tabs}</div><div class="sheet-content" id="sc">${render(0)}</div></div>`;
      window.switchSheet=idx=>{
        document.querySelectorAll('.stab').forEach((t,i)=>t.classList.toggle('active',i===idx));
        document.getElementById('sc').innerHTML=render(idx);
        const d=XLSX.utils.sheet_to_json(wb.Sheets[names[idx]],{header:1});
        document.getElementById('slines').textContent=d.length+' rows';
      };
      const d0=XLSX.utils.sheet_to_json(wb.Sheets[names[0]],{header:1});
      document.getElementById('senc').textContent=names.length+' sheets';
      document.getElementById('slines').textContent=d0.length+' rows';
    }catch(err){body.innerHTML=`<div style="padding:20px;color:var(--error);font-family:'JetBrains Mono',monospace">Failed: ${err.message}</div>`;}
  };
  reader.readAsArrayBuffer(file);
}

// ‚îÄ‚îÄ DOCX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDOCX(file,body){
  body.innerHTML=`<div style="padding:40px;text-align:center;color:var(--muted);font-family:'JetBrains Mono',monospace">Converting‚Ä¶</div>`;
  const reader=new FileReader();
  reader.onload=e=>{
    mammoth.convertToHtml({arrayBuffer:e.target.result}).then(r=>{
      body.innerHTML=`<div class="docx-viewer">${r.value}</div>`;
      document.getElementById('senc').textContent='DOCX';
      document.getElementById('slines').textContent=r.value.replace(/<[^>]+>/g,'').split(/\s+/).filter(Boolean).length+' words';
    }).catch(err=>{body.innerHTML=`<div style="padding:20px;color:var(--error);font-family:'JetBrains Mono',monospace">Failed: ${err.message}</div>`;});
  };
  reader.readAsArrayBuffer(file);
}

// ‚îÄ‚îÄ MIDI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMIDI(file,body){
  body.innerHTML=`<div class="midi-viewer"><div class="midi-header"><div style="font-size:48px">üéπ</div><div><div style="font-size:15px;font-weight:700;margin-bottom:6px">${esc(file.name)}</div><div class="midi-info" id="minfo">Parsing‚Ä¶</div></div></div><div class="piano-roll"><canvas id="mcanv" height="200"></canvas></div><div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted)">‚ÑπÔ∏è Visual piano roll. Full playback requires a Web MIDI app.</div></div>`;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const buf=new Uint8Array(e.target.result);let pos=0;
      const ru32=()=>{const v=(buf[pos]<<24)|(buf[pos+1]<<16)|(buf[pos+2]<<8)|buf[pos+3];pos+=4;return v;};
      const ru16=()=>{const v=(buf[pos]<<8)|buf[pos+1];pos+=2;return v;};
      const rvl=()=>{let v=0,b;do{b=buf[pos++];v=(v<<7)|(b&0x7f);}while(b&0x80);return v;};
      if(String.fromCharCode(...buf.slice(0,4))!=='MThd')throw new Error('Not a MIDI file');
      pos=4;ru32();
      const fmt=ru16(),ntrk=ru16(),tpb=ru16();
      const notes=[];let tempo=500000;
      for(let t=0;t<ntrk;t++){
        if(pos>=buf.length)break;
        const tag=String.fromCharCode(...buf.slice(pos,pos+4));pos+=4;
        if(tag!=='MTrk')break;
        const len=ru32(),end=pos+len;let tick=0,ls=0;
        const active={};
        while(pos<end){
          const dt=rvl();tick+=dt;
          let status=buf[pos];
          if(status&0x80){ls=status;pos++;}else status=ls;
          const type=status&0xf0,ch=status&0x0f;
          if(type===0x90){const n=buf[pos++],v=buf[pos++];if(v>0)active[n]={tick,v,ch};else if(active[n]){notes.push({note:n,start:active[n].tick,end:tick,vel:active[n].v,ch});delete active[n];}}
          else if(type===0x80){const n=buf[pos++];pos++;if(active[n]){notes.push({note:n,start:active[n].tick,end:tick,vel:active[n].v,ch});delete active[n];}}
          else if(type===0xe0||type===0xa0||type===0xb0)pos+=2;
          else if(type===0xc0||type===0xd0)pos+=1;
          else if(status===0xff){const mt=buf[pos++],ml=rvl();if(mt===0x51&&ml===3)tempo=(buf[pos]<<16)|(buf[pos+1]<<8)|buf[pos+2];pos+=ml;}
          else if(status===0xf0||status===0xf7){const sl=rvl();pos+=sl;}
          else pos++;
        }
        pos=end;
      }
      const bpm=Math.round(60000000/tempo);
      const maxT=notes.length?Math.max(...notes.map(n=>n.end)):0;
      const dur=maxT/tpb*tempo/1000000;
      const m=Math.floor(dur/60),s=Math.floor(dur%60);
      document.getElementById('minfo').innerHTML=`Format: <span>${fmt}</span> &nbsp; Tracks: <span>${ntrk}</span> &nbsp; Notes: <span>${notes.length}</span> &nbsp; BPM: <span>${bpm}</span> &nbsp; Duration: <span>${m}:${String(s).padStart(2,'0')}</span>`;
      document.getElementById('senc').textContent='MIDI';
      document.getElementById('slines').textContent=notes.length+' notes';
      const canv=document.getElementById('mcanv');
      const w=canv.parentElement.clientWidth;canv.width=w;canv.height=200;
      const ctx=canv.getContext('2d');
      ctx.fillStyle='#111118';ctx.fillRect(0,0,w,200);
      if(notes.length){
        const mn=Math.min(...notes.map(n=>n.note)),mx=Math.max(...notes.map(n=>n.note));
        const nr=Math.max(mx-mn+1,24);
        const colors=['#6ee7f7','#b47aff','#4ade80','#fbbf24','#f87171','#a78bfa','#34d399','#fb923c'];
        for(let i=0;i<=8;i++){ctx.strokeStyle='#2a2a3a';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(i*(w/8),0);ctx.lineTo(i*(w/8),200);ctx.stroke();}
        notes.forEach(n=>{
          const x=(n.start/maxT)*w,nw=Math.max(2,((n.end-n.start)/maxT)*w-1);
          const y=200-((n.note-mn+1)/(nr+2))*200,nh=Math.max(3,200/(nr+2)-1);
          ctx.fillStyle=colors[n.ch%colors.length];ctx.globalAlpha=.7+(n.vel/127)*.3;
          ctx.fillRect(x,y,nw,nh);
        });
        ctx.globalAlpha=1;
      }
    }catch(err){document.getElementById('minfo').textContent='Parse error: '+err.message;}
  };
  reader.readAsArrayBuffer(file);
}

// ‚îÄ‚îÄ SYNTAX HIGHLIGHTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function synHL(code,ext){
  let h=esc(code);
  const g=(['html','htm','xhtml','hbs','ejs','erb','twig','vue','svelte'].includes(ext))?'html':(['css','scss','sass','less','styl'].includes(ext))?'css':(['js','jsx','mjs','ts','tsx','astro'].includes(ext))?'js':(['py','pyw'].includes(ext))?'py':'x';
  if(g==='html'){h=h.replace(/(&lt;\/?)([\w-]+)/g,'$1<span class="tag">$2</span>').replace(/([\w-]+)=/g,'<span class="attr">$1</span>=').replace(/=&quot;([^&]*)&quot;/g,'=<span class="val2">&quot;$1&quot;</span>').replace(/(&lt;!--[\s\S]*?--&gt;)/g,'<span class="cmt">$1</span>');}
  else if(g==='css'){h=h.replace(/(\/\*[\s\S]*?\*\/)/g,'<span class="cmt">$1</span>').replace(/([\w-]+):/g,'<span class="prop">$1</span>:');}
  else if(g==='js'){const kw=/\b(const|let|var|function|class|return|if|else|for|while|do|switch|case|break|continue|new|delete|typeof|instanceof|import|export|default|async|await|try|catch|finally|throw|yield|from|of|in|null|undefined|true|false|this|super)\b/g;h=h.replace(/(\/\/[^\n]*)/g,'<span class="cmt">$1</span>').replace(/(&quot;[^&]*&quot;|&#039;[^&#039;]*&#039;)/g,'<span class="str">$1</span>').replace(kw,'<span class="kw">$1</span>').replace(/\b(\d+\.?\d*)\b/g,'<span class="num">$1</span>');}
  else if(g==='py'){const kw=/\b(def|class|return|if|elif|else|for|while|break|continue|import|from|as|with|try|except|finally|raise|yield|lambda|and|or|not|in|is|None|True|False|pass)\b/g;h=h.replace(/(#[^\n]*)/g,'<span class="cmt">$1</span>').replace(/(&quot;[^&\n]*&quot;|&#039;[^&#039;\n]*&#039;)/g,'<span class="str">$1</span>').replace(kw,'<span class="kw">$1</span>').replace(/\b(\d+\.?\d*)\b/g,'<span class="num">$1</span>');}
  else{h=h.replace(/(\/\/[^\n]*|#[^\n]*)/g,'<span class="cmt">$1</span>').replace(/(&quot;[^&\n]*&quot;)/g,'<span class="str">$1</span>').replace(/\b(\d+\.?\d*)\b/g,'<span class="num">$1</span>');}
  return h;
}

// ‚îÄ‚îÄ TOOLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// CONVERTER
function renderConverter(body){
  body.innerHTML=`<div class="conv-wrap">
  <div class="conv-tabs" id="ctabs">
    <div class="conv-tab active" onclick="switchConvTab('data')">Data</div>
    <div class="conv-tab" onclick="switchConvTab('text')">Text/Encode</div>
    <div class="conv-tab" onclick="switchConvTab('image')">Image</div>
    <div class="conv-tab" onclick="switchConvTab('misc')">Misc</div>
  </div>
  <div id="conv-content"></div>
  </div>`;
  switchConvTab('data');
}

function switchConvTab(tab){
  document.querySelectorAll('.conv-tab').forEach((t,i)=>t.classList.toggle('active',['data','text','image','misc'][i]===tab));
  const c=document.getElementById('conv-content');
  if(tab==='data') c.innerHTML=`
    <div class="conv-section" style="margin-top:12px"><div class="conv-head">üìä CSV ‚Üî JSON ‚Üî XML ‚Üî YAML</div><div class="conv-body">
      <div class="conv-row"><div class="conv-label">From</div><select class="conv-select" id="cv-from"><option>CSV</option><option>JSON</option><option>XML</option><option>YAML</option></select>
      <div class="conv-label">To</div><select class="conv-select" id="cv-to"><option>JSON</option><option>CSV</option><option>XML</option><option>YAML</option></select></div>
      <textarea class="conv-textarea" id="cv-input" placeholder="Paste data here‚Ä¶"></textarea>
      <div class="conv-row" style="margin-top:10px"><button class="conv-btn" onclick="doDataConvert()">Convert ‚Üí</button><button class="conv-btn" onclick="copyConvOutput()" style="margin-left:8px">Copy Output</button></div>
      <div class="conv-output" id="cv-output"></div>
    </div></div>`;
  else if(tab==='text') c.innerHTML=`
    <div class="conv-section" style="margin-top:12px"><div class="conv-head">üî§ Text Encoding</div><div class="conv-body">
      <div class="conv-row"><div class="conv-label">Operation</div><select class="conv-select" id="enc-op">
        <option value="b64e">‚Üí Base64 Encode</option><option value="b64d">‚Üê Base64 Decode</option>
        <option value="urle">‚Üí URL Encode</option><option value="urld">‚Üê URL Decode</option>
        <option value="htmle">‚Üí HTML Entities</option><option value="htmld">‚Üê HTML Decode</option>
        <option value="rot13">ROT13</option><option value="hex">‚Üí Hex</option><option value="hexd">‚Üê Hex Decode</option>
        <option value="bin">‚Üí Binary</option><option value="brev">Reverse Text</option><option value="upper">UPPERCASE</option>
        <option value="lower">lowercase</option><option value="title">Title Case</option>
      </select></div>
      <textarea class="conv-textarea" id="enc-input" placeholder="Enter text‚Ä¶"></textarea>
      <button class="conv-btn" onclick="doTextEncode()" style="margin-top:10px">Convert ‚Üí</button>
      <div class="conv-output" id="enc-output" style="margin-top:10px"></div>
    </div></div>`;
  else if(tab==='image') c.innerHTML=`
    <div class="conv-section" style="margin-top:12px"><div class="conv-head">üñº Image Converter & Resizer</div><div class="conv-body">
      <div class="conv-row">
        <button class="conv-btn" onclick="document.getElementById('img-conv-fi').click()">üìÇ Choose Image</button>
        <span id="img-fname" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1"></span>
      </div>
      <input type="file" id="img-conv-fi" accept="image/*" style="display:none" onchange="previewImgConv(this)">
      <div id="img-conv-src-preview" style="margin:8px 0"></div>
      <div class="conv-row"><div class="conv-label">Output</div>
        <select class="conv-select" id="img-fmt">
          <option value="image/png">PNG</option>
          <option value="image/jpeg" selected>JPEG</option>
          <option value="image/webp">WebP</option>
          <option value="image/bmp">BMP</option>
        </select>
      </div>
      <div class="conv-row"><div class="conv-label">Quality</div><input type="range" min="10" max="100" value="92" id="img-qual" style="accent-color:var(--accent);width:100px"><span id="img-qual-val" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);width:32px">92%</span></div>
      <div class="conv-row"><div class="conv-label">Width px</div><input type="number" id="img-w" placeholder="auto" style="width:80px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px;border-radius:6px;font-size:12px;outline:none">
      <div class="conv-label" style="margin-left:8px">Height px</div><input type="number" id="img-h" placeholder="auto" style="width:80px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px;border-radius:6px;font-size:12px;outline:none"></div>
      <div class="conv-row" style="gap:16px">
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="img-gray" style="accent-color:var(--accent)"> Grayscale</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="img-invert"> Invert</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="img-sepia"> Sepia</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="img-fliph"> Flip H</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="img-flipv"> Flip V</label>
      </div>
      <button class="conv-btn" id="img-go-btn" onclick="doImgConvert()" style="margin-top:4px">Convert & Download ‚Üí</button>
      <div id="img-conv-preview" style="margin-top:12px"></div>
    </div></div>
    <div class="conv-section" style="margin-top:12px"><div class="conv-head">üé¨ Video ‚Üí GIF / Frames</div><div class="conv-body">
      <div style="font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:10px">Capture frames from any video. GIF is assembled from canvas frames.</div>
      <div class="conv-row">
        <button class="conv-btn" onclick="document.getElementById('vid-conv-fi').click()">üìÇ Choose Video</button>
        <span id="vid-fname" style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1"></span>
      </div>
      <input type="file" id="vid-conv-fi" accept="video/*" style="display:none" onchange="loadVideoConv(this)">
      <video id="vid-conv-player" style="display:none;max-width:100%;border-radius:6px;margin:8px 0" controls playsinline></video>
      <div class="conv-row" style="margin-top:4px">
        <div class="conv-label">Frames</div>
        <select class="conv-select" id="gif-frames"><option value="10">10</option><option value="20" selected>20</option><option value="30">30</option><option value="50">50</option></select>
        <div class="conv-label">Width</div>
        <input type="number" id="gif-w" value="320" style="width:70px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px;border-radius:6px;font-size:12px;outline:none">
        <div class="conv-label">FPS</div>
        <input type="number" id="gif-fps" value="10" style="width:60px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px;border-radius:6px;font-size:12px;outline:none">
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="conv-btn" onclick="captureVideoFrames()">üéû Export Frames (PNG)</button>
        <button class="conv-btn" onclick="makeGIF()">üé® Make GIF</button>
        <button class="conv-btn" onclick="captureSnapshot()">üì∏ Snapshot</button>
      </div>
      <div id="vid-conv-out" style="margin-top:12px"></div>
    </div></div>`;
  else c.innerHTML=`
    <div class="conv-section" style="margin-top:12px"><div class="conv-head">üì¶ Archive Creator</div><div class="conv-body">
      <div style="font-size:12px;color:var(--muted);margin-bottom:10px">Drop multiple files to pack into a ZIP</div>
      <div id="zip-create-drop" style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;font-size:13px;color:var(--muted)" onclick="document.getElementById('zip-fi').click()">üì¶ Click to add files</div>
      <input type="file" id="zip-fi" multiple style="display:none" onchange="addToZip(this)">
      <div id="zip-file-list" style="margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:12px"></div>
      <button class="conv-btn" onclick="buildZip()" style="margin-top:10px">Create ZIP ‚Üì</button>
    </div></div>
    <div class="conv-section" style="margin-top:12px"><div class="conv-head">üîë TTF ‚Üí Base64 (CSS @font-face)</div><div class="conv-body">
      <button class="conv-btn" onclick="document.getElementById('font-b64-fi').click()">Choose Font</button>
      <input type="file" id="font-b64-fi" accept=".ttf,.otf,.woff,.woff2" style="display:none" onchange="fontToBase64(this)">
      <div class="conv-output" id="font-b64-out" style="margin-top:10px"></div>
    </div></div>`;
  document.getElementById('img-qual')?.addEventListener('input',function(){document.getElementById('img-qual-val').textContent=this.value+'%';});
}

let _zipFiles=[];
function addToZip(input){
  _zipFiles=[..._zipFiles,...Array.from(input.files)];
  const list=document.getElementById('zip-file-list');
  if(list)list.innerHTML=_zipFiles.map(f=>`<div style="padding:4px 0;color:var(--text)">${esc(f.name)} <span style="color:var(--muted)">(${fmtSize(f.size)})</span></div>`).join('');
}
async function buildZip(){
  if(!_zipFiles.length){alert('No files added');return;}
  const zip=new JSZip();
  for(const f of _zipFiles){const buf=await f.arrayBuffer();zip.file(f.name,buf);}
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='archive.zip';a.click();
  _zipFiles=[];
  const list=document.getElementById('zip-file-list');if(list)list.innerHTML='<div style="color:var(--success)">‚úì ZIP created!</div>';
}

function doDataConvert(){
  const from=document.getElementById('cv-from').value;
  const to=document.getElementById('cv-to').value;
  const input=document.getElementById('cv-input').value.trim();
  const out=document.getElementById('cv-output');
  if(!input){out.textContent='No input';return;}
  try{
    let data;
    // Parse input
    if(from==='CSV'){
      const rows=input.split('\n').map(r=>csvRow(r,','));
      const keys=rows[0];
      data=rows.slice(1).map(r=>Object.fromEntries(keys.map((k,i)=>[k,r[i]||''])));
    } else if(from==='JSON'){data=JSON.parse(input);}
    else if(from==='XML'){
      const doc=new DOMParser().parseFromString(input,'text/xml');
      const xmlToObj=n=>{if(n.nodeType===3)return n.textContent.trim();const obj={};n.childNodes.forEach(c=>{if(c.nodeType!==3){const v=xmlToObj(c);const k=c.nodeName;obj[k]=obj[k]?[].concat(obj[k],v):[v];}});return Object.keys(obj).length?obj:n.textContent.trim();};
      data=xmlToObj(doc.documentElement);
    } else if(from==='YAML'){
      // Simple YAML parser for flat/nested objects
      data=simpleYAMLParse(input);
    }
    // Output
    let result='';
    if(to==='JSON'){result=JSON.stringify(data,null,2);}
    else if(to==='CSV'){
      if(Array.isArray(data)&&data.length){const keys=Object.keys(data[0]);result=keys.join(',')+'\n'+data.map(r=>keys.map(k=>JSON.stringify(r[k]||'')).join(',')).join('\n');}
      else result=JSON.stringify(data);
    } else if(to==='XML'){
      const toXML=(obj,tag='root')=>{if(typeof obj!=='object'||obj===null)return`<${tag}>${esc(String(obj))}</${tag}>`;if(Array.isArray(obj))return obj.map(i=>toXML(i,tag)).join('\n');return`<${tag}>${Object.entries(obj).map(([k,v])=>toXML(v,k)).join('')}</${tag}>`;};
      result='<?xml version="1.0" encoding="UTF-8"?>\n'+toXML(data);
    } else if(to==='YAML'){result=toYAML(data);}
    out.textContent=result;
    window._convOut=result;
  }catch(e){out.textContent='Error: '+e.message;}
}

function simpleYAMLParse(yaml){
  const lines=yaml.split('\n');const root={};const stack=[{obj:root,indent:0}];
  lines.forEach(line=>{
    const m=line.match(/^(\s*)(\w[\w\s]*?):\s*(.*)?$/);
    if(!m)return;
    const indent=m[1].length,key=m[2].trim(),val=m[3]||'';
    while(stack.length>1&&stack[stack.length-1].indent>=indent)stack.pop();
    const parent=stack[stack.length-1].obj;
    if(val){parent[key]=isNaN(val)?val==='true'?true:val==='false'?false:val:Number(val);}
    else{parent[key]={};stack.push({obj:parent[key],indent});}
  });
  return root;
}

function toYAML(obj,indent=0){
  const sp=' '.repeat(indent);
  if(typeof obj!=='object'||obj===null)return String(obj);
  if(Array.isArray(obj))return obj.map(i=>`${sp}- ${toYAML(i,indent+2)}`).join('\n');
  return Object.entries(obj).map(([k,v])=>{
    if(typeof v==='object'&&v!==null)return`${sp}${k}:\n${toYAML(v,indent+2)}`;
    return`${sp}${k}: ${v}`;
  }).join('\n');
}

function doTextEncode(){
  const op=document.getElementById('enc-op').value;
  const input=document.getElementById('enc-input').value;
  const out=document.getElementById('enc-output');
  try{
    let r='';
    if(op==='b64e')r=btoa(unescape(encodeURIComponent(input)));
    else if(op==='b64d')r=decodeURIComponent(escape(atob(input)));
    else if(op==='urle')r=encodeURIComponent(input);
    else if(op==='urld')r=decodeURIComponent(input);
    else if(op==='htmle')r=input.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    else if(op==='htmld')r=input.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"');
    else if(op==='rot13')r=input.replace(/[a-zA-Z]/g,c=>{const base=c<='Z'?65:97;return String.fromCharCode((c.charCodeAt(0)-base+13)%26+base);});
    else if(op==='hex')r=Array.from(new TextEncoder().encode(input)).map(b=>b.toString(16).padStart(2,'0')).join(' ');
    else if(op==='hexd')r=new TextDecoder().decode(new Uint8Array(input.trim().split(/\s+/).map(h=>parseInt(h,16))));
    else if(op==='bin')r=Array.from(new TextEncoder().encode(input)).map(b=>b.toString(2).padStart(8,'0')).join(' ');
    else if(op==='brev')r=[...input].reverse().join('');
    else if(op==='upper')r=input.toUpperCase();
    else if(op==='lower')r=input.toLowerCase();
    else if(op==='title')r=input.replace(/\w\S*/g,t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase());
    out.textContent=r;window._convOut=r;
  }catch(e){out.textContent='Error: '+e.message;}
}

// IMAGE CONVERTER - fixed
let _imgConvFile=null;
function previewImgConv(input){
  const file=input.files[0];if(!file)return;
  _imgConvFile=file;
  document.getElementById('img-fname').textContent=file.name;
  const url=URL.createObjectURL(file);
  document.getElementById('img-conv-src-preview').innerHTML=`<img src="${url}" style="max-width:100%;max-height:140px;border-radius:6px;border:1px solid var(--border)">`;
}
function doImgConvert(){
  if(!_imgConvFile){alert('Choose an image first');return;}
  const fmt=document.getElementById('img-fmt').value;
  const qual=parseInt(document.getElementById('img-qual').value)/100;
  const gray=document.getElementById('img-gray').checked;
  const invert=document.getElementById('img-invert').checked;
  const sepia=document.getElementById('img-sepia').checked;
  const flipH=document.getElementById('img-fliph').checked;
  const flipV=document.getElementById('img-flipv').checked;
  const W=parseInt(document.getElementById('img-w').value)||0;
  const H=parseInt(document.getElementById('img-h').value)||0;
  const prev=document.getElementById('img-conv-preview');
  prev.innerHTML='<div style="color:var(--muted);font-family:\'JetBrains Mono\',monospace;font-size:12px">Converting‚Ä¶</div>';

  const img=new Image();
  img.onload=()=>{
    const outW=W||img.naturalWidth;
    const outH=H||(W?Math.round(img.naturalHeight*(W/img.naturalWidth)):img.naturalHeight);
    const c=document.createElement('canvas');
    c.width=outW;c.height=outH;
    const ctx=c.getContext('2d');
    // White background for JPEG (transparent‚Üíwhite)
    if(fmt==='image/jpeg'||fmt==='image/bmp'){ctx.fillStyle='#ffffff';ctx.fillRect(0,0,outW,outH);}
    // Flip transforms
    ctx.save();
    if(flipH||flipV){ctx.translate(flipH?outW:0,flipV?outH:0);ctx.scale(flipH?-1:1,flipV?-1:1);}
    ctx.drawImage(img,0,0,outW,outH);
    ctx.restore();
    // Pixel filters
    if(gray||invert||sepia){
      const d=ctx.getImageData(0,0,outW,outH);
      for(let i=0;i<d.data.length;i+=4){
        let r=d.data[i],g=d.data[i+1],b=d.data[i+2];
        if(gray){const v=0.299*r+0.587*g+0.114*b;r=g=b=v;}
        if(sepia){const sr=r*.393+g*.769+b*.189,sg=r*.349+g*.686+b*.168,sb=r*.272+g*.534+b*.131;r=Math.min(255,sr);g=Math.min(255,sg);b=Math.min(255,sb);}
        if(invert){r=255-r;g=255-g;b=255-b;}
        d.data[i]=r;d.data[i+1]=g;d.data[i+2]=b;
      }
      ctx.putImageData(d,0,0);
    }
    c.toBlob(blob=>{
      if(!blob){prev.innerHTML='<div style="color:var(--error);font-family:\'JetBrains Mono\',monospace;font-size:12px">Conversion failed ‚Äî try a different format</div>';return;}
      const url2=URL.createObjectURL(blob);
      const extName=fmt==='image/jpeg'?'jpg':fmt==='image/webp'?'webp':fmt==='image/bmp'?'bmp':'png';
      const origName=_imgConvFile.name.replace(/\.[^.]+$/,'');
      prev.innerHTML=`
        <img src="${url2}" style="max-width:100%;max-height:180px;border-radius:6px;border:1px solid var(--border);display:block;margin-bottom:10px">
        <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:8px">${outW}√ó${outH} ¬∑ ${fmtSize(blob.size)}</div>
        <a href="${url2}" download="${origName}.${extName}" class="conv-btn" style="display:inline-block;text-decoration:none">‚Üì Download ${extName.toUpperCase()}</a>`;
    },fmt,qual);
  };
  img.onerror=()=>{prev.innerHTML='<div style="color:var(--error);font-family:\'JetBrains Mono\',monospace;font-size:12px">Could not load image</div>';};
  img.src=URL.createObjectURL(_imgConvFile);
}
// Quality slider update
document.addEventListener('change',e=>{if(e.target.id==='img-qual')document.getElementById('img-qual-val').textContent=e.target.value+'%';});

// VIDEO CONVERTER
let _vidConvFile=null;
function loadVideoConv(input){
  const file=input.files[0];if(!file)return;
  _vidConvFile=file;
  document.getElementById('vid-fname').textContent=file.name;
  const vid=document.getElementById('vid-conv-player');
  vid.src=URL.createObjectURL(file);
  vid.style.display='block';
}

function captureSnapshot(){
  const vid=document.getElementById('vid-conv-player');
  if(!vid||!_vidConvFile){alert('Load a video first');return;}
  const c=document.createElement('canvas');
  c.width=vid.videoWidth;c.height=vid.videoHeight;
  c.getContext('2d').drawImage(vid,0,0);
  c.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    const out=document.getElementById('vid-conv-out');
    const t=Math.floor(vid.currentTime);
    out.innerHTML=`<img src="${url}" style="max-width:100%;border-radius:6px;display:block;margin-bottom:8px">
      <a href="${url}" download="snapshot_${t}s.png" class="conv-btn" style="display:inline-block;text-decoration:none">‚Üì Download PNG</a>`;
  },'image/png');
}

function captureVideoFrames(){
  const vid=document.getElementById('vid-conv-player');
  if(!vid||!_vidConvFile){alert('Load a video first');return;}
  const count=parseInt(document.getElementById('gif-frames').value)||20;
  const w=parseInt(document.getElementById('gif-w').value)||320;
  const out=document.getElementById('vid-conv-out');
  out.innerHTML='<div style="color:var(--muted);font-family:\'JetBrains Mono\',monospace;font-size:12px">Capturing frames‚Ä¶</div>';
  const dur=vid.duration;const h=Math.round(vid.videoHeight*(w/vid.videoWidth));
  const c=document.createElement('canvas');c.width=w;c.height=h;
  const ctx=c.getContext('2d');
  const frames=[];let i=0;
  const zip=new JSZip();
  const next=()=>{
    if(i>=count){
      // Build zip of frames
      zip.generateAsync({type:'blob'}).then(blob=>{
        const url=URL.createObjectURL(blob);
        out.innerHTML=`<div style="color:var(--success);font-family:'JetBrains Mono',monospace;font-size:12px;margin-bottom:8px">‚úì ${count} frames captured</div>
          <a href="${url}" download="frames.zip" class="conv-btn" style="display:inline-block;text-decoration:none">‚Üì Download ${count} PNGs (ZIP)</a>`;
      });
      return;
    }
    vid.currentTime=(i+0.5)*(dur/count);
    vid.addEventListener('seeked',()=>{
      ctx.drawImage(vid,0,0,w,h);
      c.toBlob(blob=>{
        zip.file(`frame_${String(i+1).padStart(3,'0')}.png`,blob);
        out.querySelector('div').textContent=`Capturing frames‚Ä¶ ${i+1}/${count}`;
        i++;next();
      },'image/png');
    },{once:true});
  };
  next();
}

function makeGIF(){
  const vid=document.getElementById('vid-conv-player');
  if(!vid||!_vidConvFile){alert('Load a video first');return;}
  const count=parseInt(document.getElementById('gif-frames').value)||20;
  const w=parseInt(document.getElementById('gif-w').value)||320;
  const fps=parseInt(document.getElementById('gif-fps').value)||10;
  const out=document.getElementById('vid-conv-out');
  out.innerHTML='<div style="color:var(--muted);font-family:\'JetBrains Mono\',monospace;font-size:12px">Capturing frames for GIF‚Ä¶</div>';
  const dur=vid.duration;const h=Math.round(vid.videoHeight*(w/vid.videoWidth));
  const c=document.createElement('canvas');c.width=w;c.height=h;
  const ctx=c.getContext('2d');
  const frames=[];let i=0;
  const next=()=>{
    if(i>=count){
      out.querySelector('div').textContent='Building GIF‚Ä¶';
      buildGIFFromFrames(frames,w,h,fps,out);
      return;
    }
    vid.currentTime=(i+0.5)*(dur/count);
    vid.addEventListener('seeked',()=>{
      ctx.drawImage(vid,0,0,w,h);
      frames.push(ctx.getImageData(0,0,w,h));
      out.querySelector('div').textContent=`Capturing‚Ä¶ ${i+1}/${count}`;
      i++;next();
    },{once:true});
  };
  next();
}

function buildGIFFromFrames(frames,w,h,fps,out){
  // Pure JS GIF encoder
  const delay=Math.round(100/fps);
  const buf=[];
  // GIF header
  const pushStr=s=>[...s].forEach(c=>buf.push(c.charCodeAt(0)));
  const pushU16=(n)=>{buf.push(n&0xFF,(n>>8)&0xFF);};
  pushStr('GIF89a');pushU16(w);pushU16(h);
  buf.push(0x70,0,0);// global color table flag=0, bgcolor=0, aspect=0
  // Netscape loop extension
  buf.push(0x21,0xFF,0x0B);pushStr('NETSCAPE2.0');buf.push(0x03,0x01,0x00,0x00,0x00);
  frames.forEach(frame=>{
    // Graphic control extension for delay
    buf.push(0x21,0xF9,0x04,0x00);pushU16(delay);buf.push(0,0);
    // Image descriptor
    buf.push(0x2C);pushU16(0);pushU16(0);pushU16(w);pushU16(h);
    // Local color table: quantize to 256 colors
    const {palette,indexed}=quantize(frame,w,h);
    const palSize=Math.max(palette.length,2);
    const palBits=Math.ceil(Math.log2(palSize))-1;
    const lctFlag=1;const lctSize=palBits;
    buf.push((lctFlag<<7)|(lctSize));
    // Write palette padded to 2^(palBits+1)
    const fullPal=1<<(palBits+1);
    for(let p=0;p<fullPal;p++){const c2=palette[p]||[0,0,0];buf.push(c2[0],c2[1],c2[2]);}
    // LZW compress
    const minCodeSize=Math.max(palBits+1,2);
    buf.push(minCodeSize);
    const lzw=lzwEncode(indexed,minCodeSize);
    // Write in blocks of 255
    for(let s2=0;s2<lzw.length;s2+=255){const blk=lzw.slice(s2,s2+255);buf.push(blk.length,...blk);}
    buf.push(0);// block terminator
  });
  buf.push(0x3B);// trailer
  const blob=new Blob([new Uint8Array(buf)],{type:'image/gif'});
  const url=URL.createObjectURL(blob);
  out.innerHTML=`<div style="margin-bottom:8px"><img src="${url}" style="max-width:100%;border-radius:6px;border:1px solid var(--border)"></div>
    <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:8px">${w}√ó${h} ¬∑ ${frames.length} frames ¬∑ ${fps}fps ¬∑ ${fmtSize(blob.size)}</div>
    <a href="${url}" download="animation.gif" class="conv-btn" style="display:inline-block;text-decoration:none">‚Üì Download GIF</a>`;
}

function quantize(imgData,w,h){
  // Median cut quantization to 256 colors
  const data=imgData.data;
  const pixels=[];
  for(let i=0;i<data.length;i+=4)pixels.push([data[i],data[i+1],data[i+2]]);
  const cut=(pixels,depth)=>{
    if(depth===0||pixels.length===0)return[avgColor(pixels)];
    const ch=dominantChannel(pixels);
    pixels.sort((a,b)=>a[ch]-b[ch]);
    const mid=Math.floor(pixels.length/2);
    return[...cut(pixels.slice(0,mid),depth-1),...cut(pixels.slice(mid),depth-1)];
  };
  const palette=cut(pixels,8).slice(0,256);
  const indexed=pixels.map(p=>{
    let best=0,bestD=Infinity;
    palette.forEach((c,i)=>{const d=(p[0]-c[0])**2+(p[1]-c[1])**2+(p[2]-c[2])**2;if(d<bestD){bestD=d;best=i;}});
    return best;
  });
  return{palette,indexed};
}
function avgColor(px){if(!px.length)return[0,0,0];return[Math.round(px.reduce((s,p)=>s+p[0],0)/px.length),Math.round(px.reduce((s,p)=>s+p[1],0)/px.length),Math.round(px.reduce((s,p)=>s+p[2],0)/px.length)];}
function dominantChannel(px){const ranges=[0,1,2].map(c=>{const vals=px.map(p=>p[c]);return Math.max(...vals)-Math.min(...vals);});return ranges.indexOf(Math.max(...ranges));}

function lzwEncode(indices,minSize){
  const clearCode=1<<minSize,eoi=clearCode+1;
  let codeSize=minSize+1,nextCode=eoi+1;
  const table=new Map();
  const resetTable=()=>{table.clear();for(let i=0;i<clearCode;i++)table.set(String(i),i);};
  resetTable();
  const bits=[];const writeBits=(code,size)=>{for(let i=0;i<size;i++)bits.push((code>>i)&1);};
  writeBits(clearCode,codeSize);
  let buf=String(indices[0]);
  for(let i=1;i<indices.length;i++){
    const ext=buf+','+indices[i];
    if(table.has(ext)){buf=ext;}
    else{
      writeBits(table.get(buf),codeSize);
      table.set(ext,nextCode++);
      if(nextCode>(1<<codeSize)&&codeSize<12)codeSize++;
      if(nextCode>=4096){writeBits(clearCode,codeSize);resetTable();codeSize=minSize+1;nextCode=eoi+1;}
      buf=String(indices[i]);
    }
  }
  writeBits(table.get(buf),codeSize);
  writeBits(eoi,codeSize);
  // Pack bits into bytes
  const bytes=[];
  for(let i=0;i<bits.length;i+=8){let b=0;for(let j=0;j<8&&i+j<bits.length;j++)b|=bits[i+j]<<j;bytes.push(b);}
  return bytes;
}

function fontToBase64(input){
  const file=input.files[0];if(!file)return;
  const out=document.getElementById('font-b64-out');
  out.textContent='Converting‚Ä¶';
  const reader=new FileReader();
  reader.onload=e=>{
    const b64=e.target.result.split(',')[1];
    const ext2=file.name.split('.').pop().toLowerCase();
    const mimeMap={ttf:'truetype',otf:'opentype',woff:'woff',woff2:'woff2'};
    const css=`@font-face {\n  font-family: 'MyFont';\n  src: url('data:font/${mimeMap[ext2]||ext2};base64,${b64}') format('${mimeMap[ext2]||ext2}');\n}`;
    out.textContent=css;window._convOut=css;
  };
  reader.readAsDataURL(file);
}

function copyConvOutput(){
  const t=window._convOut||document.getElementById('cv-output')?.textContent||document.getElementById('enc-output')?.textContent||'';
  if(t)navigator.clipboard.writeText(t).then(()=>{});
}

// DIFF VIEWER
let _diffFiles=[null,null];
function renderDiff(body){
  body.innerHTML=`<div style="padding:14px;display:flex;flex-direction:column;gap:12px;height:100%;overflow:auto">
    <div class="diff-drop-row">
      <div class="diff-drop" id="dd0" onclick="document.getElementById('dfi0').click()">üìÑ Drop File A<br><span style="font-size:10px">or click</span></div>
      <div class="diff-drop" id="dd1" onclick="document.getElementById('dfi1').click()">üìÑ Drop File B<br><span style="font-size:10px">or click</span></div>
    </div>
    <input type="file" id="dfi0" style="display:none" onchange="loadDiffFile(0,this)">
    <input type="file" id="dfi1" style="display:none" onchange="loadDiffFile(1,this)">
    <button class="conv-btn" onclick="runDiff()">‚ö° Compare</button>
    <div id="diff-out"></div>
  </div>`;
}
function loadDiffFile(idx,input){
  const file=input.files[0];if(!file)return;
  readText(file,text=>{
    _diffFiles[idx]=text;
    const dd=document.getElementById('dd'+idx);
    dd.textContent=file.name;dd.classList.add('loaded');
  });
}
function runDiff(){
  const [a,b]=_diffFiles;
  if(!a||!b){document.getElementById('diff-out').innerHTML='<div style="color:var(--error);font-family:\'JetBrains Mono\',monospace;font-size:12px">Load both files first</div>';return;}
  const la=a.split('\n'),lb=b.split('\n');
  const maxLen=Math.max(la.length,lb.length);
  let leftHtml='',rightHtml='',adds=0,dels=0;
  for(let i=0;i<maxLen;i++){
    const l=la[i],r=lb[i];
    if(l===r){leftHtml+=`<span class="diff-line diff-eq">${esc(l||'')}</span>`;rightHtml+=`<span class="diff-line diff-eq">${esc(r||'')}</span>`;}
    else{
      if(l!==undefined){leftHtml+=`<span class="diff-line diff-del">${esc(l)}</span>`;dels++;}
      else leftHtml+=`<span class="diff-line diff-eq"></span>`;
      if(r!==undefined){rightHtml+=`<span class="diff-line diff-add">${esc(r)}</span>`;adds++;}
      else rightHtml+=`<span class="diff-line diff-eq"></span>`;
    }
  }
  document.getElementById('diff-out').innerHTML=`
    <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);margin-bottom:8px">+${adds} additions ¬∑ -${dels} deletions</div>
    <div class="diff-output">
      <div class="diff-col"><div class="diff-col-head">File A</div>${leftHtml}</div>
      <div class="diff-col" style="border-left:1px solid var(--border)"><div class="diff-col-head">File B</div>${rightHtml}</div>
    </div>`;
  document.getElementById('slines').textContent=`+${adds} -${dels}`;
}

// HASH CHECKER
async function renderHash(body){
  body.innerHTML=`<div class="hash-wrap">
    <div style="font-size:13px;font-weight:700;margin-bottom:4px">Drop a file to compute its hashes</div>
    <div style="font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:12px">All hashing done locally in your browser</div>
    <div id="hash-drop" style="border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:12px" onclick="document.getElementById('hfi').click()">üîí Drop or click to load file</div>
    <input type="file" id="hfi" style="display:none" onchange="computeHashes(this)">
    <div id="hash-results"></div>
    <div class="hash-row" style="margin-top:4px">
      <div class="hash-label">Verify hash:</div>
      <input class="hash-input" id="hash-verify" placeholder="Paste expected hash to verify‚Ä¶" oninput="verifyHash()">
      <div class="hash-match" id="hash-match"></div>
    </div>
  </div>`;
}
async function computeHashes(input){
  const file=input.files[0];if(!file)return;
  const drop=document.getElementById('hash-drop');
  drop.textContent='‚è≥ Computing‚Ä¶';
  const buf=await file.arrayBuffer();
  const algos=['SHA-1','SHA-256','SHA-384','SHA-512'];
  const results=await Promise.all(algos.map(a=>crypto.subtle.digest(a,buf)));
  const hashes={};
  algos.forEach((a,i)=>{hashes[a]=Array.from(new Uint8Array(results[i])).map(b=>b.toString(16).padStart(2,'0')).join('');});
  // MD5 (simple impl)
  hashes['MD5']=simpleMD5(new Uint8Array(buf));
  drop.textContent='‚úì '+file.name;drop.style.borderColor='var(--success)';drop.style.color='var(--success)';
  window._hashes=hashes;
  document.getElementById('hash-results').innerHTML=Object.entries(hashes).map(([a,v])=>`
    <div class="hash-row">
      <div class="hash-label" style="display:flex;align-items:center;gap:6px">${a}<button class="hash-copy" onclick="navigator.clipboard.writeText('${v}')">Copy</button></div>
      <div class="hash-val" onclick="navigator.clipboard.writeText('${v}')">${v}</div>
    </div>`).join('');
  document.getElementById('slines').textContent=fmtSize(file.size);
}
function verifyHash(){
  const val=document.getElementById('hash-verify').value.trim().toLowerCase();
  const match=document.getElementById('hash-match');
  if(!val||!window._hashes){match.className='hash-match';return;}
  const found=Object.values(window._hashes).some(h=>h===val);
  match.className='hash-match '+(found?'ok':'fail');
  match.textContent=found?'‚úì Hash matches!':'‚úó Hash does not match';
}
// Minimal MD5 for file verification
function simpleMD5(input){
  function safeAdd(x,y){const lsw=(x&0xFFFF)+(y&0xFFFF);const msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);}
  function bitRotateLeft(num,cnt){return(num<<cnt)|(num>>>(32-cnt));}
  function md5cmn(q,a,b,x,s,t){return safeAdd(bitRotateLeft(safeAdd(safeAdd(a,q),safeAdd(x,t)),s),b);}
  function md5ff(a,b,c,d,x,s,t){return md5cmn((b&c)|((~b)&d),a,b,x,s,t);}
  function md5gg(a,b,c,d,x,s,t){return md5cmn((b&d)|(c&(~d)),a,b,x,s,t);}
  function md5hh(a,b,c,d,x,s,t){return md5cmn(b^c^d,a,b,x,s,t);}
  function md5ii(a,b,c,d,x,s,t){return md5cmn(c^(b|(~d)),a,b,x,s,t);}
  const l=input.length;const nblocks=((l+8)>>6)+1;const blocks=new Array(nblocks*16).fill(0);
  for(let i=0;i<l;i++)blocks[i>>2]|=input[i]<<((i%4)*8);
  blocks[l>>2]|=0x80<<((l%4)*8);blocks[nblocks*16-2]=l*8;blocks[nblocks*16-1]=0;
  let a=0x67452301,b=0xEFCDAB89,c=0x98BADCFE,d=0x10325476;
  for(let i=0;i<nblocks*16;i+=16){
    const[A,B,C,D]=[a,b,c,d];
    a=md5ff(a,b,c,d,blocks[i+0],7,-680876936);d=md5ff(d,a,b,c,blocks[i+1],12,-389564586);c=md5ff(c,d,a,b,blocks[i+2],17,606105819);b=md5ff(b,c,d,a,blocks[i+3],22,-1044525330);
    a=md5ff(a,b,c,d,blocks[i+4],7,-176418897);d=md5ff(d,a,b,c,blocks[i+5],12,1200080426);c=md5ff(c,d,a,b,blocks[i+6],17,-1473231341);b=md5ff(b,c,d,a,blocks[i+7],22,-45705983);
    a=md5ff(a,b,c,d,blocks[i+8],7,1770035416);d=md5ff(d,a,b,c,blocks[i+9],12,-1958414417);c=md5ff(c,d,a,b,blocks[i+10],17,-42063);b=md5ff(b,c,d,a,blocks[i+11],22,-1990404162);
    a=md5ff(a,b,c,d,blocks[i+12],7,1804603682);d=md5ff(d,a,b,c,blocks[i+13],12,-40341101);c=md5ff(c,d,a,b,blocks[i+14],17,-1502002290);b=md5ff(b,c,d,a,blocks[i+15],22,1236535329);
    a=md5gg(a,b,c,d,blocks[i+1],5,-165796510);d=md5gg(d,a,b,c,blocks[i+6],9,-1069501632);c=md5gg(c,d,a,b,blocks[i+11],14,643717713);b=md5gg(b,c,d,a,blocks[i+0],20,-373897302);
    a=md5gg(a,b,c,d,blocks[i+5],5,-701558691);d=md5gg(d,a,b,c,blocks[i+10],9,38016083);c=md5gg(c,d,a,b,blocks[i+15],14,-660478335);b=md5gg(b,c,d,a,blocks[i+4],20,-405537848);
    a=md5gg(a,b,c,d,blocks[i+9],5,568446438);d=md5gg(d,a,b,c,blocks[i+14],9,-1019803690);c=md5gg(c,d,a,b,blocks[i+3],14,-187363961);b=md5gg(b,c,d,a,blocks[i+8],20,1163531501);
    a=md5gg(a,b,c,d,blocks[i+13],5,-1444681467);d=md5gg(d,a,b,c,blocks[i+2],9,-51403784);c=md5gg(c,d,a,b,blocks[i+7],14,1735328473);b=md5gg(b,c,d,a,blocks[i+12],20,-1926607734);
    a=md5hh(a,b,c,d,blocks[i+5],4,-378558);d=md5hh(d,a,b,c,blocks[i+8],11,-2022574463);c=md5hh(c,d,a,b,blocks[i+11],16,1839030562);b=md5hh(b,c,d,a,blocks[i+14],23,-35309556);
    a=md5hh(a,b,c,d,blocks[i+1],4,-1530992060);d=md5hh(d,a,b,c,blocks[i+4],11,1272893353);c=md5hh(c,d,a,b,blocks[i+7],16,-155497632);b=md5hh(b,c,d,a,blocks[i+10],23,-1094730640);
    a=md5hh(a,b,c,d,blocks[i+13],4,681279174);d=md5hh(d,a,b,c,blocks[i+0],11,-358537222);c=md5hh(c,d,a,b,blocks[i+3],16,-722521979);b=md5hh(b,c,d,a,blocks[i+6],23,76029189);
    a=md5hh(a,b,c,d,blocks[i+9],4,-640364487);d=md5hh(d,a,b,c,blocks[i+12],11,-421815835);c=md5hh(c,d,a,b,blocks[i+15],16,530742520);b=md5hh(b,c,d,a,blocks[i+2],23,-995338651);
    a=md5ii(a,b,c,d,blocks[i+0],6,-198630844);d=md5ii(d,a,b,c,blocks[i+7],10,1126891415);c=md5ii(c,d,a,b,blocks[i+14],15,-1416354905);b=md5ii(b,c,d,a,blocks[i+5],21,-57434055);
    a=md5ii(a,b,c,d,blocks[i+12],6,1700485571);d=md5ii(d,a,b,c,blocks[i+3],10,-1894986606);c=md5ii(c,d,a,b,blocks[i+10],15,-1051523);b=md5ii(b,c,d,a,blocks[i+1],21,-2054922799);
    a=md5ii(a,b,c,d,blocks[i+8],6,1873313359);d=md5ii(d,a,b,c,blocks[i+15],10,-30611744);c=md5ii(c,d,a,b,blocks[i+6],15,-1560198380);b=md5ii(b,c,d,a,blocks[i+13],21,1309151649);
    a=md5ii(a,b,c,d,blocks[i+4],6,-145523070);d=md5ii(d,a,b,c,blocks[i+11],10,-1120210379);c=md5ii(c,d,a,b,blocks[i+2],15,718787259);b=md5ii(b,c,d,a,blocks[i+9],21,-343485551);
    a=safeAdd(a,A);b=safeAdd(b,B);c=safeAdd(c,C);d=safeAdd(d,D);
  }
  return[a,b,c,d].map(n=>Array.from({length:4},(_,i)=>((n>>(i*8))&0xff).toString(16).padStart(2,'0')).join('')).join('');
}

// QR GENERATOR
function renderQR(body){
  body.innerHTML=`<div class="conv-wrap">
    <div class="conv-section"><div class="conv-head">üì± QR Code Generator</div><div class="conv-body">
      <textarea class="conv-textarea" id="qr-input" placeholder="Enter text, URL, or any data‚Ä¶" style="min-height:80px"></textarea>
      <div class="conv-row" style="margin-top:10px">
        <div class="conv-label">Size</div>
        <select class="conv-select" id="qr-size"><option value="128">Small (128)</option><option value="256" selected>Medium (256)</option><option value="512">Large (512)</option></select>
        <div class="conv-label">Color</div>
        <input type="color" id="qr-color" value="#6ee7f7" style="width:40px;height:34px;border:1px solid var(--border);border-radius:6px;background:none;cursor:pointer">
      </div>
      <button class="conv-btn" onclick="generateQR()" style="margin-top:8px">Generate QR ‚Üí</button>
      <div class="conv-canvas-wrap" id="qr-out" style="margin-top:12px"></div>
    </div></div>
  </div>`;
}
function generateQR(){
  const text=document.getElementById('qr-input').value.trim();
  if(!text)return;
  const size=parseInt(document.getElementById('qr-size').value);
  const color=document.getElementById('qr-color').value;
  const out=document.getElementById('qr-out');
  out.innerHTML='<div id="qr-canvas"></div>';
  new QRCode(document.getElementById('qr-canvas'),{text,width:size,height:size,colorDark:color,colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.H});
  setTimeout(()=>{
    const img=out.querySelector('img')||out.querySelector('canvas');
    if(img){
      const a=document.createElement('a');a.href=img.src||img.toDataURL();a.download='qrcode.png';
      const btn=document.createElement('button');btn.className='conv-btn';btn.textContent='‚Üì Download PNG';btn.style.marginTop='10px';
      btn.onclick=()=>a.click();
      out.appendChild(btn);
    }
  },200);
}

// TEXT TOOLS
function renderTextTools(body){
  body.innerHTML=`<div class="conv-wrap">
    <div class="conv-section"><div class="conv-head">üìù Text Tools</div><div class="conv-body">
      <textarea class="conv-textarea" id="tt-in" placeholder="Paste text here‚Ä¶" style="min-height:120px"></textarea>
      <div style="display:flex;flex-wrap:wrap;gap:7px;margin-top:10px">
        <button class="conv-btn" onclick="tt('sort')">Sort Lines ‚Üë</button>
        <button class="conv-btn" onclick="tt('sortd')">Sort Lines ‚Üì</button>
        <button class="conv-btn" onclick="tt('dedup')">Deduplicate</button>
        <button class="conv-btn" onclick="tt('trim')">Trim Lines</button>
        <button class="conv-btn" onclick="tt('nonempty')">Remove Empty</button>
        <button class="conv-btn" onclick="tt('numbr')">Number Lines</button>
        <button class="conv-btn" onclick="tt('shuffle')">Shuffle Lines</button>
        <button class="conv-btn" onclick="tt('rev')">Reverse Lines</button>
        <button class="conv-btn" onclick="tt('count')">Word Count</button>
        <button class="conv-btn" onclick="tt('freq')">Word Frequency</button>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="tt-find" class="conv-textarea" placeholder="Find‚Ä¶" style="min-height:auto;padding:8px;flex:1;min-width:100px">
        <input id="tt-replace" class="conv-textarea" placeholder="Replace with‚Ä¶" style="min-height:auto;padding:8px;flex:1;min-width:100px">
        <button class="conv-btn" onclick="tt('replace')">Replace All</button>
      </div>
      <div class="conv-output" id="tt-out" style="margin-top:10px;min-height:80px"></div>
      <button class="conv-btn" onclick="if(window._ttOut)navigator.clipboard.writeText(window._ttOut)" style="margin-top:8px">Copy Output</button>
    </div></div>
  </div>`;
}
function tt(op){
  const input=document.getElementById('tt-in').value;
  const out=document.getElementById('tt-out');
  let lines=input.split('\n'),result='';
  if(op==='sort')lines.sort();
  else if(op==='sortd')lines.sort().reverse();
  else if(op==='dedup')lines=[...new Set(lines)];
  else if(op==='trim')lines=lines.map(l=>l.trim());
  else if(op==='nonempty')lines=lines.filter(l=>l.trim());
  else if(op==='numbr')lines=lines.map((l,i)=>`${i+1}. ${l}`);
  else if(op==='shuffle')lines.sort(()=>Math.random()-.5);
  else if(op==='rev')lines.reverse();
  else if(op==='count'){
    const words=input.trim().split(/\s+/).filter(Boolean);
    result=`Characters: ${input.length}\nWords: ${words.length}\nLines: ${lines.length}\nUnique words: ${new Set(words.map(w=>w.toLowerCase())).size}`;
    out.textContent=result;window._ttOut=result;return;
  } else if(op==='freq'){
    const freq={};input.toLowerCase().split(/\W+/).filter(w=>w.length>2).forEach(w=>freq[w]=(freq[w]||0)+1);
    result=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,30).map(([w,c])=>`${c.toString().padStart(4)} ${w}`).join('\n');
    out.textContent=result;window._ttOut=result;return;
  } else if(op==='replace'){
    const f=document.getElementById('tt-find').value;
    const r=document.getElementById('tt-replace').value;
    result=f?input.replaceAll(f,r):input;
    out.textContent=result;window._ttOut=result;return;
  }
  result=lines.join('\n');
  out.textContent=result;window._ttOut=result;
}

// IMAGE EDITOR TOOL
function renderImgEdit(body){
  body.innerHTML=`<div class="img-editor">
    <div class="img-toolbar">
      <button class="tbtn" onclick="document.getElementById('ie-fi').click()">Open Image</button>
      <input type="file" id="ie-fi" accept="image/*" style="display:none" onchange="loadImgEdit(this)">
      <div class="img-slider"><span>Brightness</span><input type="range" id="ie-br" min="-100" max="100" value="0" oninput="applyFilters()"><span id="ie-br-v">0</span></div>
      <div class="img-slider"><span>Contrast</span><input type="range" id="ie-co" min="-100" max="100" value="0" oninput="applyFilters()"><span id="ie-co-v">0</span></div>
      <div class="img-slider"><span>Saturation</span><input type="range" id="ie-sa" min="-100" max="100" value="0" oninput="applyFilters()"><span id="ie-sa-v">0</span></div>
      <button class="tbtn" onclick="applyFilters(true)">Grayscale</button>
      <button class="tbtn" onclick="applyFilter_invert()">Invert</button>
      <button class="tbtn" onclick="downloadCanvas()">‚Üì Save</button>
    </div>
    <div class="img-canvas-wrap"><canvas id="ie-canvas"></canvas></div>
  </div>`;
  body.style.height='100%';
}
let _ieImg=null,_ieGray=false,_ieInvert=false;
function loadImgEdit(input){
  const file=input.files[0];if(!file)return;
  const img=new Image();
  img.onload=()=>{
    _ieImg=img;_ieGray=false;_ieInvert=false;
    document.getElementById('ie-br').value=0;document.getElementById('ie-co').value=0;document.getElementById('ie-sa').value=0;
    applyFilters();
  };
  img.src=URL.createObjectURL(file);
}
function applyFilters(gray=false){
  if(gray)_ieGray=!_ieGray;
  if(!_ieImg)return;
  const br=parseInt(document.getElementById('ie-br').value);
  const co=parseInt(document.getElementById('ie-co').value);
  const sa=parseInt(document.getElementById('ie-sa').value);
  document.getElementById('ie-br-v').textContent=br;
  document.getElementById('ie-co-v').textContent=co;
  document.getElementById('ie-sa-v').textContent=sa;
  const c=document.getElementById('ie-canvas');
  c.width=_ieImg.naturalWidth;c.height=_ieImg.naturalHeight;
  const ctx=c.getContext('2d');
  ctx.filter=`brightness(${1+br/100}) contrast(${1+co/100}) saturate(${_ieGray?0:1+sa/100}) ${_ieInvert?'invert(1)':''}`;
  ctx.drawImage(_ieImg,0,0);
}
function applyFilter_invert(){_ieInvert=!_ieInvert;applyFilters();}
function downloadCanvas(){
  const c=document.getElementById('ie-canvas');if(!c)return;
  const a=document.createElement('a');a.href=c.toDataURL('image/png');a.download='edited.png';a.click();
}

// ‚îÄ‚îÄ SHARE / FULLSCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function shareFile(){
  if(!currentFile||!navigator.share)return;
  try{await navigator.share({files:[currentFile],title:currentFile.name});}catch(e){}
}
function toggleFullscreen(){
  const el=document.getElementById('vbody');
  if(!document.fullscreenElement)el.requestFullscreen().catch(()=>{});
  else document.exitFullscreen();
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}
function readText(file,cb){const r=new FileReader();r.onload=e=>cb(e.target.result);r.readAsText(file,'UTF-8');}
function copyContent(){
  const t=window._ct;
  if(t)navigator.clipboard.writeText(t).then(()=>{const b=document.getElementById('tbtn-copy');b.textContent='‚úì';setTimeout(()=>b.textContent='Copy',1500);});
}

// Init recent badge
if(recentFiles.length){const b=document.createElement('div');b.className='badge';b.textContent=recentFiles.length;document.getElementById('btn-recent').appendChild(b);}
// Share button visibility
if(!navigator.share)document.getElementById('tbtn-share').style.display='none';
</script>
</body>
</html>
